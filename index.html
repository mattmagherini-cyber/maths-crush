<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Maths Quest 2D</title>
<style>
    /* --- STYLE G√âN√âRAL --- */
    body { 
        margin: 0; 
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
        font-family: 'Segoe UI', sans-serif; 
        color: white; 
        overflow-x: hidden;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    /* --- MENU PRINCIPAL --- */
    #main-menu { 
        padding: 20px; padding-top: 100px; 
        max-width: 600px; margin: 0 auto; padding-bottom: 120px;
        min-height: 100vh;
        display: flex; flex-direction: column; justify-content: flex-end; 
    }
    
    /* --- MONDES & PORTES --- */
    .world-container {
        position: relative; margin-bottom: 40px; padding-bottom: 20px;
        display: flex; flex-direction: column; align-items: center;
    }
    .world-title {
        background: rgba(0,0,0,0.4); padding: 8px 20px; border-radius: 20px;
        font-weight: 800; letter-spacing: 2px; margin-bottom: 20px;
        text-transform: uppercase; font-size: 0.9rem; color: #81ecec;
        border: 1px solid rgba(129, 236, 236, 0.3); z-index: 2;
    }
    .world-path-line {
        position: absolute; top: 50px; bottom: 0; left: 50%; width: 6px;
        background: rgba(255,255,255,0.15); transform: translateX(-50%);
        border-radius: 4px; z-index: 0;
    }
    .gate-locked {
        background: #2d3436; border: 2px dashed #d63031; border-radius: 15px;
        padding: 30px; text-align: center; width: 80%; margin: 20px 0;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; z-index: 5;
    }
    .gate-icon { font-size: 2rem; margin-bottom: 10px; }
    .gate-text { color: #fab1a0; font-weight: bold; }
    .gate-req { font-size: 1.5rem; color: #f1c40f; font-weight: 900; }

    /* --- BOUTONS NIVEAUX --- */
    .lvl-btn { 
        width: 75px; height: 75px; border-radius: 50%;
        background: #2d3436; border: 4px solid rgba(255,255,255,0.3); 
        color: white; font-size: 1.3rem; font-weight: bold; cursor: pointer;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        position: relative; z-index: 2; margin: 15px 0; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: transform 0.1s;
    }
    .lvl-btn:active { transform: scale(0.95); }
    .lvl-btn.current { border-color: #00cec9; background: #00cec9; box-shadow: 0 0 20px rgba(0, 206, 201, 0.6); color: #2d3436; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    
    .lvl-btn.creative-mode { border-color: #a29bfe; background: rgba(162, 155, 254, 0.1); }
    .lvl-btn.locked { opacity: 0.6; background: #1e272e; border-color: #444; color: #555; pointer-events: none; }
    .lvl-btn.star3 { border-color: #f1c40f; background: #2d3436; box-shadow: 0 0 15px rgba(241, 196, 15, 0.4); }
    .stars-icon { font-size: 0.7rem; margin-top: -2px; color: #f1c40f; letter-spacing: 1px; }

    /* --- HUD --- */
    .hud-top { 
        position: fixed; top: 0; left: 0; width: 100%; height: 80px;
        background: rgba(20, 20, 30, 0.95); backdrop-filter: blur(5px); z-index: 50;
        display: flex; justify-content: space-between; align-items: center;
        border-bottom: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        padding: 0 20px; box-sizing: border-box;
    }
    .stat-val { font-size: 1.5rem; font-weight: 800; display: block; color:#00d2d3; } 
    .stat-label { font-size: 0.75rem; opacity: 0.6; text-transform: uppercase; letter-spacing: 1px; }
    .settings-btn { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: white; transition: transform 0.3s; }
    .settings-btn:hover { transform: rotate(90deg); }

    /* --- √âCRAN DE JEU --- */
    #game-screen { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: #2d3436; z-index: 100; 
        display: flex; flex-direction: column; align-items: center; justify-content: center; 
        transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); 
    }
    #game-screen.active { transform: translateY(0); }
    #game-screen.error-flash { animation: flashRed 0.4s ease-out; }
    @keyframes flashRed { 0%, 100% { background: #2d3436; } 50% { background: #c0392b; } }

    /* --- PARAM√àTRES (MODAL) --- */
    #settings-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 200;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    #settings-screen.active { opacity: 1; pointer-events: all; }
    
    .settings-content {
        background: #2d3436; padding: 30px; border-radius: 20px;
        width: 85%; max-width: 400px; text-align: center;
        border: 1px solid #555;
    }
    .setting-row { margin: 20px 0; display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; font-weight: bold; }
    .creative-label { color: #fdcb6e; text-align: left; }

    .switch { position: relative; display: inline-block; width: 60px; height: 34px; flex-shrink: 0; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #00cec9; }
    input:checked + .slider:before { transform: translateX(26px); }

    .btn-toggle-creative { background: #6c5ce7; color: white; border: none; padding: 15px 20px; border-radius: 8px; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer; font-size: 1rem; border: 2px solid #a29bfe; transition: background 0.2s; }
    .btn-toggle-creative.active { background: #00b894; border-color: #55efc4; }
    .btn-danger { background: #d63031; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; width: 100%; margin-top: 25px; cursor: pointer; font-size: 1rem; }
    .btn-close-settings { background: #b2bec3; color: #2d3436; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; width: 100%; margin-top: 15px; cursor: pointer; font-size: 1.2rem; }

    /* Barres (Progression + Temps) */
    .bars-container { width: 85%; max-width: 360px; margin-bottom: 10px; }
    
    /* Chronom√®tre */
    .timer-bar-container { width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; margin-bottom: 8px; overflow: hidden; }
    .timer-bar-fill { height: 100%; background: #00cec9; width: 100%; transition: width 1s linear, background 0.3s; }
    /* Couleurs du timer */
    .timer-bar-fill.medium { background: #fdcb6e; }
    .timer-bar-fill.low { background: #d63031; }

    /* Progression Niveau */
    .level-progress-container { width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; overflow: hidden; }
    .level-progress-fill { height: 100%; background: #6c5ce7; width: 0%; transition: width 0.3s; }
    
    .progress-text { font-size: 0.8rem; color: #dfe6e9; margin-top: 5px; font-weight: bold; text-align: right; }

    .q-display { font-size: 3rem; font-weight: 900; margin: 10px 0 20px 0; text-align: center; color: #fff; }
    .inp-display { font-size: 2.5rem; min-width: 220px; padding: 0 20px; margin-bottom: 25px; background: rgba(0,0,0,0.4); border: 2px solid #00cec9; border-radius: 12px; text-align: center; color: #00cec9; height: 70px; line-height: 70px; }
    .numpad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 95%; max-width: 360px; }
    .key { padding: 15px 0; font-size: 1.4rem; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; background: #dfe6e9; color: #2d3436; box-shadow: 0 4px 0 #b2bec3; transition: transform 0.1s; }
    .key:active { transform: translateY(4px); box-shadow: 0 0 0 #b2bec3; }
    .k-ok { background: #00b894; color: white; grid-column: span 4; margin-top: 5px; box-shadow: 0 4px 0 #00886e; }
    .k-del { background: #d63031; color: white; box-shadow: 0 4px 0 #a11d1e; }
    .k-op { background: #74b9ff; color: white; box-shadow: 0 4px 0 #0984e3; pointer-events: none; } 
    .k-close { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; width: 40px; height: 40px; color: white; font-size: 1.5rem; cursor: pointer; line-height: 35px; }
    .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; } 
    @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }
</style>
</head>
<body>

<div class="hud-top">
    <button class="settings-btn" onclick="window.settings.open()">‚öôÔ∏è</button>
    <div style="text-align:center"><span class="stat-val">‚≠ê <span id="ui-stars">0</span></span><span class="stat-label">Total</span></div>
    <div style="text-align:center"><span class="stat-val" id="ui-lvl">1</span><span class="stat-label">Prochain</span></div>
</div>

<div id="settings-screen">
    <div class="settings-content">
        <h2>Param√®tres</h2>
        <div class="setting-row">
            <span>üì≥ Vibrations</span>
            <label class="switch">
                <input type="checkbox" id="toggle-vib" onchange="window.settings.save()">
                <span class="slider"></span>
            </label>
        </div>
        <hr style="border-color:#555; margin: 20px 0;">
        <p style="font-size:0.9rem; color:#a29bfe; margin-bottom:5px;">Mode Cr√©atif (Tout ouvert + Rapide)</p>
        <button id="btn-creative" class="btn-toggle-creative" onclick="window.settings.toggleCreative()">Activer Mode Cr√©atif</button>
        <button class="btn-danger" onclick="window.settings.resetData()">üóëÔ∏è R√©initialiser tout</button>
        <button class="btn-close-settings" onclick="window.settings.close()">Fermer</button>
    </div>
</div>

<div id="main-menu">
    <div id="grid-container"></div>
</div>

<div id="game-screen">
    <button class="k-close" onclick="window.game.close()">√ó</button>
    <div style="color:rgba(255,255,255,0.5); font-weight:bold; letter-spacing:1px; text-transform:uppercase;">Niveau <span id="g-lvl-num">1</span></div>
    
    <div class="bars-container">
        <div class="timer-bar-container">
            <div class="timer-bar-fill" id="g-timer-bar"></div>
        </div>
        <div class="level-progress-container">
            <div class="level-progress-fill" id="g-prog-bar"></div>
        </div>
        <div class="progress-text"><span id="g-prog-txt">0</span> / <span id="g-target-txt">20</span></div>
    </div>

    <div class="q-display" id="g-quest">?</div>
    <div class="inp-display" id="g-inp"></div>
    <div class="numpad">
        <button class="key" onclick="window.game.tap('7')">7</button><button class="key" onclick="window.game.tap('8')">8</button><button class="key" onclick="window.game.tap('9')">9</button><button class="key k-op">√∑</button>
        <button class="key" onclick="window.game.tap('4')">4</button><button class="key" onclick="window.game.tap('5')">5</button><button class="key" onclick="window.game.tap('6')">6</button><button class="key k-op">√ó</button>
        <button class="key" onclick="window.game.tap('1')">1</button><button class="key" onclick="window.game.tap('2')">2</button><button class="key" onclick="window.game.tap('3')">3</button><button class="key k-op">-</button>
        <button class="key" onclick="window.game.tap('0')">0</button><button class="key" onclick="window.game.tap('.')">,</button><button class="key k-del" onclick="window.game.tap('DEL')">‚å´</button><button class="key k-op">+</button>
        <button class="key k-ok" onclick="window.game.validate()">VALIDER</button>
    </div>
</div>

<script>

            
  






    // --- MOTEUR DU JEU ---

    // 1. LE G√âN√âRATEUR (C≈ìur math√©matique intact)
    function generateProblem(lvl) {
        let themeIdx = (lvl - 1) % 20; 
        let world = Math.ceil(lvl / 20); 
        let rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        
        let n1, n2, ans, op, txt;

        switch(themeIdx) {
          
            
            // --- TH√àME 1 : LES COMPL√âMENTS (Indice 0) ---
        // Niveaux concern√©s : 1, 21, 41, 61 ... jusqu'√† 481
        case 0:
            if (world == 1) { // L1 : Base 10 simple
                n1 = rand(1, 9); 
                ans = 10 - n1; 
                op = `10 - ${n1}`; 
                txt = "Compl√©ment √† 10";
            } 
            else if (world == 2) { // L21 : Inconnue √† 10
                n1 = rand(1, 9); 
                ans = 10 - n1; 
                op = `${n1} + ? = 10`; 
                txt = "Trouve le manquant";
            } 
            else if (world == 3) { // L41 : Base 20 (Sans retenue)
                let u = rand(1, 4); // 1,2,3,4
                n1 = 10 + u; // 11 √† 14
                ans = 20 - n1; 
                op = `20 - ${n1}`; 
                txt = "Compl√©ment √† 20";
            } 
            else if (world == 4) { // L61 : Base 20 (Avec retenue)
                n1 = rand(5, 9); // 5 √† 9
                ans = 20 - n1; 
                op = `20 - ${n1}`; 
                txt = "Passe la dizaine";
            } 
            else if (world == 5) { // L81 : Dizaine Sup√©rieure
                n1 = rand(21, 28); 
                let sup = Math.ceil(n1/10)*10; // ex: 24 -> 30
                ans = sup - n1; 
                op = `${n1} pour aller √† ${sup}`; 
                txt = "Dizaine suivante";
            }
            else if (world == 6) { // L101 : Base 100 (Dizaines rondes)
                n1 = rand(1, 9) * 10; 
                ans = 100 - n1; 
                op = `100 - ${n1}`; 
                txt = "Compl√©ment √† 100";
            }
            else if (world == 7) { // L121 : Le Pivot 50
                n1 = rand(1, 49);
                ans = 50 - n1;
                op = `50 - ${n1}`;
                txt = "Compl√©ment √† 50";
            }
            else if (world == 8) { // L141 : Inconnue 100
                n1 = rand(1, 9) * 10;
                ans = 100 - n1;
                op = `? + ${n1} = 100`;
                txt = "√âquation √† trou";
            }
            else if (world == 9) { // L161 : Base 60 (Intro Temps)
                n1 = rand(1, 5) * 10; // 10, 20... 50
                ans = 60 - n1;
                op = `60 - ${n1}`;
                txt = "Base 60 (Heure)";
            }
            else if (world == 10) { // L181 : Arrondir (Grands nombres)
                n1 = rand(51, 88);
                let sup = Math.ceil(n1/10)*10;
                ans = sup - n1;
                op = `${n1} -> ${sup}`;
                txt = "Boucle la dizaine";
            }
            else if (world == 11) { // L201 : Le Pi√®ge du 5 (100)
                n1 = rand(1, 9) * 10 + 5; // 15, 25... 95
                ans = 100 - n1;
                op = `100 - ${n1}`;
                txt = "Attention au 5";
            }
            else if (world == 12) { // L221 : Base 100 (Unit√©s faibles)
                // ex: 23. R√®gle: 2->7, 3->7.
                let d = rand(2, 8); let u = rand(1, 4);
                n1 = d*10 + u;
                ans = 100 - n1;
                op = `100 - ${n1}`;
                txt = "R√®gle du 9 et 10";
            }
            else if (world == 13) { // L241 : Base 100 (Unit√©s fortes)
                // ex: 48. R√®gle: 4->5, 8->2.
                let d = rand(2, 8); let u = rand(6, 9);
                n1 = d*10 + u;
                ans = 100 - n1;
                op = `100 - ${n1}`;
                txt = "Grosse retenue";
            }
            else if (world == 14) { // L261 : Base 100 (Petits nombres)
                n1 = rand(4, 9);
                ans = 100 - n1;
                op = `100 - ${n1}`;
                txt = "Attention au z√©ro";
            }
            else if (world == 15) { // L281 : Base 100 (Grands nombres)
                n1 = rand(91, 98);
                ans = 100 - n1;
                op = `100 - ${n1}`;
                txt = "Petit √©cart";
            }
            else if (world == 16) { // L301 : Base 1000 (Centaines rondes)
                n1 = rand(1, 9) * 100;
                ans = 1000 - n1;
                op = `1000 - ${n1}`;
                txt = "Compl√©ment 1000";
            }
            else if (world == 17) { // L321 : Base 1000 (Dizaines rondes)
                // ex: 1000 - 340
                n1 = rand(11, 89) * 10;
                ans = 1000 - n1;
                op = `1000 - ${n1}`;
                txt = "R√®gle des 2 premiers";
            }
            else if (world == 18) { // L341 : Pivot 500
                n1 = rand(1, 499);
                ans = 500 - n1;
                op = `500 - ${n1}`;
                txt = "Compl√©ment 500";
            }
            else if (world == 19) { // L361 : Heure Pr√©cise
                n1 = rand(11, 49);
                ans = 60 - n1;
                op = `60 - ${n1}`;
                txt = "Minutes restantes";
            }
            else if (world == 20) { // L381 : Passage heure sup
                // ex: Il est 4h45, min avant 5h ?
                let h = rand(1, 11);
                let m = rand(35, 55);
                ans = 60 - m;
                op = `${h}h${m} -> ${h+1}h00`;
                txt = "Minutes avant l'heure";
            }
            else if (world == 21) { // L401 : Compl√©ment √† 1 (D√©cimale simple)
                let d = rand(1, 9); // 0.x
                n1 = d/10;
                ans = parseFloat((1 - n1).toFixed(1));
                op = `1 - ${n1}`;
                txt = "Compl√©ment √† 1";
            }
            else if (world == 22) { // L421 : Compl√©ment √† 1 (Centimes)
                let c = rand(15, 85); // 0.xx
                n1 = c/100;
                ans = parseFloat((1 - n1).toFixed(2));
                op = `1 - ${n1}`;
                txt = "Rendu Monnaie";
            }
            else if (world == 23) { // L441 : Compl√©ment entier sup
                // ex: 4.2 -> 5
                let e = rand(1, 9);
                let d = rand(1, 9);
                n1 = e + d/10;
                ans = parseFloat((1 - d/10).toFixed(1));
                op = `${n1} -> ${e+1}`;
                txt = "Entier suivant";
            }
            else if (world == 24) { // L461 : Le Grand Chelem (1000)
                // R√®gle 9, 9, 10
                n1 = rand(123, 876);
                ans = 1000 - n1;
                op = `1000 - ${n1}`;
                txt = "R√®gle 9-9-10";
            }
            else { // L481 : BOSS FINAL (Equation)
                let x = rand(25, 75);
                n1 = 100 - x;
                ans = x;
                op = `x + ${n1} = 100`;
                txt = "Trouve x";
            }
            break;

            // === TH√àME 2 : L'ADDITION (Niveaux 2, 22, 42... 482) ===
            case 1:
                // --- PHASE 1 : LA FLUIDIT√â (Mondes 1-5) ---
                if (world == 1) { // Unit√©s (1 √† 9)
                    n1 = rand(1, 5); 
                    n2 = rand(1, 4); 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "Unit√©s simples";
                } 
                else if (world == 2) { // Le Pont du 10 (6 √† 18)
                    n1 = rand(5, 9); 
                    n2 = rand(2, 9); 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "Passe le 10";
                } 
                else if (world == 3) { // Collage (40 + 5)
                    n1 = rand(1, 9) * 10; 
                    n2 = rand(1, 9); 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "Colle les nombres";
                } 
                else if (world == 4) { // Dizaines rondes (30 + 40)
                    n1 = rand(1, 5) * 10; 
                    n2 = rand(1, 4) * 10; 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "Comme les unit√©s";
                } 
                else if (world == 5) { // 2 chiffres + 1 (Sans retenue)
                    n1 = rand(11, 25); 
                    n2 = rand(1, 4); 
                    // S√©curit√© anti-retenue
                    if ((n1 % 10) + n2 >= 10) n2 = 1; 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "Juste les unit√©s";
                }

                // --- PHASE 2 : LA RETENUE MENTALE (Mondes 6-10) ---
                else if (world == 6) { // Le Saut de 9 (+10 -1)
                    n1 = rand(15, 35); 
                    n2 = 9; 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "+10 moins 1";
                } 
                else if (world == 7) { // Le Saut de 8 (+10 -2)
                    n1 = rand(15, 45); 
                    n2 = 8; 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "+10 moins 2";
                } 
                else if (world == 8) { // Compl√©ter la dizaine (27+3)
                    n1 = rand(11, 29); 
                    let unit = n1 % 10;
                    n2 = 10 - unit; // Compl√©ment exact
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "Vise la dizaine";
                } 
                else if (world == 9) { // Franchissement simple (27+5)
                    n1 = rand(15, 28); 
                    n2 = (10 - (n1%10)) + rand(1,3); // Force le passage
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "Compl√®te et avance";
                } 
                else if (world == 10) { // Presque Jumeaux (6+7)
                    n1 = rand(5, 9); 
                    n2 = n1 + 1; 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "Double + 1";
                }

                // --- PHASE 3 : D√âCOMPOSITION (Mondes 11-15) ---
                else if (world == 11) { // 2 chiffres sans retenue (23+41)
                    // G√©n√©ration s√ªre sans retenue
                    let d1 = rand(1,4); let u1 = rand(1,4);
                    let d2 = rand(1,4); let u2 = rand(1,4);
                    n1 = d1*10 + u1; n2 = d2*10 + u2;
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "Dizaines puis Unit√©s";
                } 
                else if (world == 12) { // Avec retenue simple (28+15)
                    n1 = rand(15, 38); 
                    n2 = rand(11, 19); 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "D√©compose le 2√®me";
                } 
                else if (world == 13) { // M√©thode Lego (45+37)
                    n1 = rand(25, 45); 
                    n2 = rand(25, 35); 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "Dizaines d'abord";
                } 
                else if (world == 14) { // Passage de 100 (Dizaines)
                    n1 = rand(5, 9) * 10; 
                    n2 = rand(5, 9) * 10; 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "Passe le 100";
                } 
                else if (world == 15) { // Passage 100 Mixte (75+50)
                    n1 = rand(65, 85); 
                    n2 = rand(20, 50); 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "Compl√®te √† 100";
                }

                // --- PHASE 4 : AGILIT√â (Mondes 16-20) ---
                else if (world == 16) { // Associativit√© (4+9+6)
                    let a = rand(1,9); 
                    let c = 10 - a; 
                    let b = rand(2,9);
                    ans = a + b + c; 
                    op = `${a} + ${b} + ${c}`; 
                    txt = "Regroupe le 10 !";
                } 
                else if (world == 17) { // Associativit√© Ronds (15+48+5)
                    let a = rand(1,9)*10 + 5; // ex 15
                    let c = 5; 
                    let b = rand(11, 49);
                    ans = a + b + c; 
                    op = `${a} + ${b} + ${c}`; 
                    txt = "Cherche le rond";
                } 
                else if (world == 18) { // Centaines + Dizaines (120+50)
                    n1 = rand(1, 5) * 100 + rand(1,4)*10; // 120, 340...
                    n2 = rand(1, 5) * 10; // 30, 50...
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "Ne m√©lange pas tout";
                } 
                else if (world == 19) { // Sandwich (150+150)
                    n1 = rand(1, 4) * 100 + 50; 
                    n2 = n1; 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "Double des centaines";
                } 
                else if (world == 20) { // Miroir (23+32)
                    let d = rand(1,4); let u = rand(1,4);
                    n1 = d*10 + u; 
                    n2 = u*10 + d;
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "Effet Miroir";
                }

                // --- PHASE 5 : MONDE R√âEL (Mondes 21-25) ---
                else if (world == 21) { // D√©cimale simple (2.5 + 3.5)
                    let e1 = rand(1,5); let e2 = rand(1,5);
                    n1 = e1 + 0.5; 
                    n2 = e2 + 0.5;
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "Les demis font 1";
                } 
                else if (world == 22) { // Alignement (1.5 + 0.25)
                    n1 = 1.5; 
                    n2 = 0.25; 
                    ans = 1.75; 
                    op = `${n1} + ${n2}`; 
                    txt = "Attention, 1.50 !";
                    // Variation al√©atoire
                    if (rand(0,1)) { n1=2.5; n2=0.5; ans=3; txt="Fait un entier"; }
                } 
                else if (world == 23) { // Argent (0.60 + 0.80)
                    let c1 = rand(5,9)*10; 
                    let c2 = rand(5,9)*10;
                    n1 = c1/100; n2 = c2/100;
                    ans = parseFloat((n1 + n2).toFixed(2)); 
                    op = `${n1.toFixed(2)} + ${n2.toFixed(2)}`; 
                    txt = "Compte les centimes";
                } 
                else if (world == 24) { // Grands Nombres (140 + 235)
                    n1 = rand(1,3)*100 + rand(1,4)*10; // ex 140
                    n2 = rand(2,4)*100 + rand(2,5)*10 + 5; // ex 235
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "D√©compose tout";
                } 
                else { // BOSS FINAL (Equation Invers√©e)
                    let x = rand(50, 150);
                    let target = Math.ceil(x/100)*100 + 100; // Cible ronde sup
                    n1 = target - x;
                    ans = n1;
                    op = `${x} + x = ${target}`;
                    txt = "Trouve x";
                }
                break;

           // === TH√àME 3 : DOUBLES ET MOITI√âS (Niveaux 3, 23, 43... 483) ===
            case 2:
                // --- PHASE 1 : BASES (Mondes 1-5) ---
                if (world == 1) { // Doubles simples (1 √† 10)
                    n1 = rand(1, 10); 
                    ans = n1 * 2; 
                    op = `Double de ${n1}`; 
                    txt = "Table de 2";
                } 
                else if (world == 2) { // Moiti√©s paires (2 √† 20)
                    ans = rand(1, 10); 
                    n1 = ans * 2; 
                    op = `Moiti√© de ${n1}`; 
                    txt = "Partage en 2";
                } 
                else if (world == 3) { // Doubles ados (11 √† 19)
                    n1 = rand(11, 19); 
                    ans = n1 * 2; 
                    op = `Double de ${n1}`; 
                    txt = "10+10 et le reste";
                } 
                else if (world == 4) { // Doubles dizaines (20, 30, 40)
                    n1 = rand(2, 4) * 10; 
                    ans = n1 * 2; 
                    op = `Double de ${n1}`; 
                    txt = "Double le chiffre";
                } 
                else if (world == 5) { // Moiti√©s dizaines (40, 60, 80)
                    ans = rand(2, 4) * 10; 
                    n1 = ans * 2; 
                    op = `Moiti√© de ${n1}`; 
                    txt = "Moiti√© du chiffre";
                }

                // --- PHASE 2 : LOGIQUE (Mondes 6-15) ---
                else if (world == 6) { // Double sans retenue (23, 34...)
                    let d = rand(2, 4); let u = rand(1, 4);
                    n1 = d * 10 + u; 
                    ans = n1 * 2; 
                    op = `Double de ${n1}`; 
                    txt = "Double tout";
                } 
                else if (world == 7) { // Moiti√© sans reste (46, 28...)
                    let d = rand(2, 4) * 2; // Dizaine paire
                    let u = rand(1, 4) * 2; // Unit√© paire
                    n1 = d * 10 + u; 
                    ans = n1 / 2; 
                    op = `Moiti√© de ${n1}`; 
                    txt = "Coupe tout en 2";
                } 
                else if (world == 8) { // Le Pivot 15 (Double de 15, 25, 35...)
                    n1 = rand(1, 4) * 10 + 5; 
                    ans = n1 * 2; 
                    op = `Double de ${n1}`; 
                    txt = "Le 5 fait une dizaine";
                } 
                else if (world == 9) { // Le Pivot 50 (Moiti√© de 50, 30, 70...)
                    // Moiti√© de 50 c'est 25. Moiti√© de 30 c'est 15.
                    let d = rand(0, 4) * 2 + 1; // 1, 3, 5, 7, 9
                    n1 = d * 10; 
                    ans = n1 / 2; 
                    op = `Moiti√© de ${n1}`; 
                    txt = "Finit par 5";
                } 
                else if (world == 10) { // Double avec retenue (16, 17, 18, 19)
                    n1 = rand(16, 19); 
                    ans = n1 * 2; 
                    op = `Double de ${n1}`; 
                    txt = "Double 15 et ajoute";
                }
                else if (world == 11) { // Les centaines (100, 200, 150)
                    n1 = rand(1, 4) * 50; // 50, 100, 150...
                    ans = n1 * 2; 
                    op = `Double de ${n1}`; 
                    txt = "Gros double";
                }
                else if (world == 12) { // Moiti√© de 100, 300, 500
                    let c = rand(0, 4) * 2 + 1; // 1, 3, 5...
                    n1 = c * 100;
                    ans = n1 / 2;
                    op = `Moiti√© de ${n1}`;
                    txt = "Moiti√© de cent";
                }
                else if (world == 13) { // Double de 25, 75
                    n1 = rand(0, 1) ? 25 : 75;
                    ans = n1 * 2;
                    op = `Double de ${n1}`;
                    txt = "Monnaie (25cts)";
                }
                else if (world == 14) { // Moiti√© de 50 et 150
                    n1 = rand(0, 1) ? 50 : 150;
                    ans = n1 / 2;
                    op = `Moiti√© de ${n1}`;
                    txt = "Partage en 2";
                }
                else if (world == 15) { // La Cha√Æne (4 -> 8 -> 16)
                    n1 = rand(2, 8);
                    ans = n1 * 4;
                    op = `Le quadruple de ${n1}`;
                    txt = "Double du double";
                }

                // --- PHASE 3 : ABSTRACTION & VIRGULES (Mondes 16-25) ---
                else if (world == 16) { // Intro Virgule : Moiti√© de 1, 3, 5
                    n1 = rand(0, 4) * 2 + 1; // Impair
                    ans = n1 / 2;
                    op = `Moiti√© de ${n1}`;
                    txt = "Virgule 5 (.5)";
                }
                else if (world == 17) { // Double de 1.5, 2.5, 3.5
                    let e = rand(1, 10);
                    n1 = e + 0.5;
                    ans = n1 * 2;
                    op = `Double de ${n1}`;
                    txt = "Demi fait 1";
                }
                else if (world == 18) { // Moiti√© d'impairs complexes (13, 17...)
                    n1 = rand(6, 14) * 2 + 1; // 13 √† 29
                    ans = n1 / 2;
                    op = `Moiti√© de ${n1}`;
                    txt = "Finit par .5";
                }
                else if (world == 19) { // Double de d√©cimal (1.2, 2.4)
                    let e = rand(1, 5);
                    let d = rand(1, 4);
                    n1 = e + d/10; // ex: 2.3
                    ans = n1 * 2;
                    op = `Double de ${n1}`;
                    txt = "Double tout";
                }
                else if (world == 20) { // Quart (Moiti√© de moiti√©)
                    n1 = rand(1, 5) * 4; // Multiple de 4
                    ans = n1 / 4;
                    op = `Le quart de ${n1}`;
                    txt = "Moiti√© de moiti√©";
                }
                else if (world == 21) { // Moiti√© de 0.5 (0.25)
                    n1 = 0.5; ans = 0.25; op = `Moiti√© de 0.5`; txt = "Le quart";
                    if(rand(0,1)) { n1=1.5; ans=0.75; op=`Moiti√© de 1.5`; txt="0.5 + 0.25"; }
                }
                else if (world == 22) { // Double de 0.25 (0.5)
                    n1 = 0.25; ans = 0.5; op = `Double de 0.25`; txt = "Demi";
                    if(rand(0,1)) { n1=0.75; ans=1.5; op=`Double de 0.75`; txt="1.5"; }
                }
                else if (world == 23) { // Grands nombres (Mille)
                    n1 = rand(11, 45) * 100; // 1100, 2500...
                    ans = n1 * 2;
                    op = `Double de ${n1}`;
                    txt = "Comme les unit√©s";
                }
                else if (world == 24) { // Moiti√© de Grands nombres
                    let m = rand(12, 48) * 2; // Pair
                    n1 = m * 100; // 2400...
                    ans = n1 / 2;
                    op = `Moiti√© de ${n1}`;
                    txt = "Comme les unit√©s";
                }
                else { // BOSS FINAL (M√©lange Double/Moiti√© D√©cimal Complexe)
                    if(rand(0,1)) {
                        let e = rand(12, 25);
                        n1 = e + 0.5; // 12.5
                        ans = n1 * 2;
                        op = `Double de ${n1}`;
                        txt = "Final Double";
                    } else {
                        n1 = rand(15, 35) * 2 + 1; // Impair 31..71
                        ans = n1 / 2;
                        op = `Moiti√© de ${n1}`;
                        txt = "Final Moiti√©";
                    }
                }
                break;

// === TH√àME 4 : SOUSTRACTION / √âCARTS (Niveaux 4, 24, 44... 484) ===
            case 3:
                // --- PHASE 1 : LES PETITS SAUTS (Mondes 1-5) ---
                if (world == 1) { // √âcart de 1, 2 ou 3 (Unit√©s)
                    ans = rand(1, 3); // L'√©cart est petit
                    let n2 = rand(1, 6); // Le petit chiffre
                    n1 = n2 + ans; // Le grand chiffre
                    op = `${n1} - ${n2}`; 
                    txt = "Compte en montant";
                } 
                else if (world == 2) { // Passage de 10 (12 - 9)
                    let n2 = rand(8, 9); 
                    n1 = rand(11, 14); 
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    txt = "Passe le 10";
                } 
                else if (world == 3) { // Depuis 20 (20 - 17)
                    let n2 = rand(11, 19); 
                    n1 = 20; 
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    txt = "Compl√®te √† 20";
                } 
                else if (world == 4) { // Soustraire 10 (35 - 10)
                    n1 = rand(20, 50); 
                    let n2 = 10; 
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    txt = "Recule d'une dizaine";
                } 
                else if (world == 5) { // Petits √©carts sur grands nombres (45 - 42)
                    ans = rand(1, 4); 
                    let n2 = rand(30, 60); 
                    n1 = n2 + ans; 
                    op = `${n1} - ${n2}`; 
                    txt = "Ils sont proches";
                }

                // --- PHASE 2 : LE SAUT DE PUCE (Mondes 6-10) ---
                else if (world == 6) { // Compl√©ment dizaine (30 - 24)
                    let d = rand(3, 6) * 10; // 30, 40, 50...
                    let u = rand(1, 9);
                    let n2 = d - u;
                    n1 = d;
                    ans = u;
                    op = `${n1} - ${n2}`; 
                    txt = "Vise le rond";
                } 
                else if (world == 7) { // Le Pont (32 - 28)
                    let base = rand(2, 5) * 10; // ex: 30
                    let n2 = base - rand(1, 4); // 28
                    n1 = base + rand(1, 4); // 32
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    txt = "Passe le pont";
                } 
                else if (world == 8) { // La technique du -9
                    n1 = rand(25, 55); 
                    let n2 = 9; 
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    txt = "-10 et +1";
                } 
                else if (world == 9) { // La technique du -8
                    n1 = rand(25, 55); 
                    let n2 = 8; 
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    txt = "-10 et +2";
                } 
                else if (world == 10) { // √âcart moyen (50 - 35)
                    n1 = rand(4, 8) * 10; // 50
                    let n2 = n1 - rand(11, 19); // 35
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    txt = "Monte de 10 en 10";
                }

                // --- PHASE 3 : LOGIQUE ET PI√àGES (Mondes 11-15) ---
                else if (world == 11) { // Dizaines identiques (87 - 82)
                    // Pi√®ge visuel : on a peur des gros chiffres
                    let base = rand(7, 9) * 10; 
                    ans = rand(2, 7); 
                    n1 = base + rand(ans+1, 9);
                    let n2 = n1 - ans;
                    op = `${n1} - ${n2}`; 
                    txt = "Regarde les unit√©s";
                } 
                else if (world == 12) { // Autour de 100 (102 - 98)
                    let n2 = rand(91, 99); 
                    n1 = rand(101, 105); 
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    txt = "Passe le 100";
                } 
                else if (world == 13) { // Demi-centaines (100 - 48)
                    n1 = 100; 
                    let n2 = rand(41, 59); 
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    txt = "Compl√©ment 100";
                } 
                else if (world == 14) { // Sandwich (65 - 35)
                    n1 = rand(5, 9) * 10 + 5; // 65
                    let n2 = n1 - 30; 
                    ans = 30; 
                    op = `${n1} - ${n2}`; 
                    txt = "Les 5 s'annulent";
                } 
                else if (world == 15) { // √âcart constant (42 - 39 -> 3)
                    let n2 = rand(35, 75); 
                    n1 = n2 + 3; 
                    ans = 3; 
                    op = `${n1} - ${n2}`; 
                    txt = "Tout petit √©cart";
                }

                // --- PHASE 4 : GRANDS ESPACES (Mondes 16-20) ---
                else if (world == 16) { // Recul Simple (150 - 10)
                    n1 = rand(12, 19) * 10; 
                    ans = n1 - 10; 
                    op = `${n1} - 10`; 
                    txt = "Recul d'une case";
                } 
                else if (world == 17) { // Dizaines rondes (300 - 290)
                    n1 = rand(2, 5) * 100; 
                    let n2 = n1 - 10; 
                    ans = 10; 
                    op = `${n1} - ${n2}`; 
                    txt = "Juste 10";
                } 
                else if (world == 18) { // Pont de centaine (305 - 298)
                    let base = rand(2, 5) * 100; 
                    let n2 = base - rand(1, 5); 
                    n1 = base + rand(1, 5); 
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    txt = "Passe le 00";
                } 
                else if (world == 19) { // 1000 (1000 - x)
                    n1 = 1000; 
                    let n2 = rand(900, 990); 
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    txt = "Compl√©ment 1000";
                } 
                else if (world == 20) { // Palindromes (52 - 25)
                    // Astuce : La diff√©rence est toujours un multiple de 9
                    let d = rand(4, 8); let u = rand(1, d-1);
                    n1 = d*10 + u; // 52
                    let n2 = u*10 + d; // 25
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    txt = "Diff√©rence x9";
                }

                // --- PHASE 5 : ABSTRACTION & R√âEL (Mondes 21-25) ---
                else if (world == 21) { // D√©cimale facile (5 - 4.5)
                    n1 = rand(3, 9); 
                    let n2 = n1 - 0.5; 
                    ans = 0.5; 
                    op = `${n1} - ${n2}`; 
                    txt = "Juste un demi";
                } 
                else if (world == 22) { // Argent (10 - 3.50)
                    n1 = 10; 
                    let n2 = rand(1, 8) + 0.5; // 3.5
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    txt = "Rendu sur 10‚Ç¨";
                } 
                else if (world == 23) { // Temps (1h - 45min)
                    n1 = 60; 
                    let n2 = 45; 
                    ans = 15; 
                    op = `${n1} - ${n2}`; 
                    txt = "Minutes restantes";
                    if(rand(0,1)) { n2=15; ans=45; }
                } 
                else if (world == 24) { // Gros √©cart (500 - 125)
                    n1 = 500; 
                    let n2 = 125; 
                    ans = 375; 
                    op = `${n1} - ${n2}`; 
                    txt = "Compl√©ment 500";
                    if(rand(0,1)) { n2=250; ans=250; }
                } 
                else { // BOSS FINAL (Trouve le terme manquant)
                    let target = rand(50, 90); 
                    let diff = rand(5, 15);
                    n1 = target + diff;
                    ans = diff;
                    op = `${n1} - x = ${target}`;
                    txt = "Trouve l'√©cart";
                }
                break;

// === TH√àME 5 : MULTIPLICATION / TABLES INVERS√âES (Niveaux 5, 25... 485) ===
            case 4:
                // --- PHASE 1 : L'APPRENTISSAGE (Mondes 1-5) ---
                if (world == 1) { // Tables faciles (2, 5, 10)
                    let t = [2, 5, 10][rand(0, 2)];
                    n1 = t; 
                    n2 = rand(1, 9);
                    ans = n1 * n2; 
                    op = `${n1} x ${n2}`; 
                    txt = "Tables faciles";
                } 
                else if (world == 2) { // Tables 3 et 4
                    n1 = rand(3, 4); 
                    n2 = rand(1, 9); 
                    ans = n1 * n2; 
                    op = `${n1} x ${n2}`; 
                    txt = "Tables 3 et 4";
                } 
                else if (world == 3) { // Tables 6 et 7
                    n1 = rand(6, 7); 
                    n2 = rand(1, 9); 
                    ans = n1 * n2; 
                    op = `${n1} x ${n2}`; 
                    txt = "√áa se complique";
                } 
                else if (world == 4) { // Tables 8 et 9
                    n1 = rand(8, 9); 
                    n2 = rand(1, 9); 
                    ans = n1 * n2; 
                    op = `${n1} x ${n2}`; 
                    txt = "Les plus dures";
                } 
                else if (world == 5) { // Carr√©s (Jusqu'√† 10)
                    n1 = rand(2, 9); 
                    ans = n1 * n1; 
                    op = `${n1} x ${n1}`; 
                    txt = "Carr√© parfait";
                }

                // --- PHASE 2 : L'INVERSION "QUI EST ?" (Mondes 6-10) ---
                // C'est le c≈ìur du concept : trouver le facteur manquant
                else if (world == 6) { // Trouve le multiplicateur (Tables 2-5)
                    n1 = rand(2, 5); 
                    ans = rand(2, 9); 
                    let res = n1 * ans; 
                    op = `${n1} x ? = ${res}`; 
                    txt = "Trouve le manquant";
                } 
                else if (world == 7) { // Trouve le multiplicateur (Tables 6-9)
                    n1 = rand(6, 9); 
                    ans = rand(2, 9); 
                    let res = n1 * ans; 
                    op = `? x ${n1} = ${res}`; 
                    txt = "Qui est le parent ?";
                } 
                else if (world == 8) { // La Preuve par 9
                    ans = rand(2, 9); 
                    let res = ans * 9; 
                    op = `? x 9 = ${res}`; 
                    txt = "Table de 9";
                } 
                else if (world == 9) { // Carr√©s invers√©s
                    ans = rand(2, 9); 
                    let res = ans * ans; 
                    op = `? x ? = ${res}`; 
                    txt = "Quelle est la racine ?";
                } 
                else if (world == 10) { // Le Pi√®ge du 0 et 1
                    if (rand(0, 1)) {
                        n1 = rand(10, 99); ans = 0; op = `${n1} x 0`; txt = "T√™te √† Toto";
                    } else {
                        n1 = rand(10, 99); ans = n1; op = `${n1} x 1`; txt = "L'√©l√©ment neutre";
                    }
                }

                // --- PHASE 3 : LA DIVISION D√âGUIS√âE (Mondes 11-15) ---
                else if (world == 11) { // Division exacte (Tables 2-5)
                    ans = rand(2, 9); 
                    let div = rand(2, 5);
                    n1 = ans * div; 
                    op = `${n1} / ${div}`; 
                    txt = "C'est une table !";
                } 
                else if (world == 12) { // Division exacte (Tables 6-9)
                    ans = rand(2, 9); 
                    let div = rand(6, 9);
                    n1 = ans * div; 
                    op = `${n1} / ${div}`; 
                    txt = "Inverse mentalement";
                } 
                else if (world == 13) { // Table de 11 et 12 (Faciles)
                    n1 = rand(11, 12); 
                    n2 = rand(2, 9); 
                    ans = n1 * n2; 
                    op = `${n1} x ${n2}`; 
                    txt = "Hors-piste";
                } 
                else if (world == 14) { // Multiples de 10 (3 x 40)
                    n1 = rand(2, 9); 
                    n2 = rand(2, 9) * 10; 
                    ans = n1 * n2; 
                    op = `${n1} x ${n2}`; 
                    txt = "Cache le z√©ro";
                } 
                else if (world == 15) { // Inversion multiple de 10
                    ans = rand(2, 9); 
                    let n2 = rand(2, 9) * 10; 
                    let res = ans * n2;
                    op = `${n2} x ? = ${res}`; 
                    txt = "Trouve le petit";
                }

                // --- PHASE 4 : MENTAL EXPERT (Mondes 16-20) ---
                else if (world == 16) { // Associativit√© (2 x 3 x 4)
                    let a = rand(2, 4); 
                    let b = rand(2, 3); 
                    let c = rand(2, 4);
                    ans = a * b * c; 
                    op = `${a} x ${b} x ${c}`; 
                    txt = "Groupe les petits";
                } 
                else if (world == 17) { // Doublement (24 x 2)
                    // C'est une multiplication, mais on pense en double
                    n1 = rand(12, 45); 
                    ans = n1 * 2; 
                    op = `${n1} x 2`; 
                    txt = "Table de 2 (Double)";
                } 
                else if (world == 18) { // D√©composition simple (12 x 3)
                    // 10x3 + 2x3
                    let u = rand(1, 4); 
                    n1 = 10 + u; 
                    n2 = rand(3, 5); 
                    ans = n1 * n2; 
                    op = `${n1} x ${n2}`; 
                    txt = "10x... et le reste";
                } 
                else if (world == 19) { // Alg√®bre (6x = 42)
                    ans = rand(2, 9); 
                    let coeff = rand(6, 9); 
                    let res = ans * coeff; 
                    op = `${coeff}x = ${res}`; 
                    txt = "Trouve x";
                } 
                else if (world == 20) { // Carr√©s dizaines (30 x 30)
                    n1 = rand(2, 9) * 10; 
                    ans = n1 * n1; 
                    op = `${n1}¬≤`; 
                    txt = "Carr√© x100";
                }

                // --- PHASE 5 : MA√éTRISE (Mondes 21-25) ---
                else if (world == 21) { // Gros z√©ros (50 x 60)
                    n1 = rand(2, 9) * 10; 
                    n2 = rand(2, 9) * 10; 
                    ans = n1 * n2; 
                    op = `${n1} x ${n2}`; 
                    txt = "Deux z√©ros !";
                } 
                else if (world == 22) { // x50 (x100 / 2)
                    n1 = rand(2, 12) * 2; // Pair
                    ans = n1 * 50; 
                    op = `${n1} x 50`; 
                    txt = "Moiti√© x 100";
                } 
                else if (world == 23) { // x25 (x100 / 4)
                    n1 = rand(1, 6) * 4; // Multiple de 4
                    ans = n1 * 25; 
                    op = `${n1} x 25`; 
                    txt = "Quart x 100";
                } 
                else if (world == 24) { // Mental Pur (15 x 6)
                    // Astuce : double/moiti√© (15x6 -> 30x3)
                    let a = rand(3, 6) * 5; // 15, 20, 25...
                    let b = rand(2, 4) * 2; // Pair
                    ans = a * b; 
                    op = `${a} x ${b}`; 
                    txt = "Double l'un, coupe l'autre";
                } 
                else { // BOSS FINAL (Priorit√©s)
                    // (6 x 8) + 2
                    let a = rand(6, 9); 
                    let b = rand(6, 9); 
                    let c = rand(1, 9);
                    ans = (a * b) + c; 
                    op = `(${a} x ${b}) + ${c}`; 
                    txt = "Table + nombre";
                }
                break;

// === TH√àME 6 : PUISSANCES DE 10 / D√âCALAGE (Niveaux 6, 26... 486) ===
            case 5:
                // --- PHASE 1 : LE "0" VISIBLE (Mondes 1-5) ---
                if (world == 1) { // x10 Entiers (3 x 10)
                    n1 = rand(2, 25); 
                    ans = n1 * 10; 
                    op = `${n1} x 10`; 
                    txt = "Ajoute un 0";
                } 
                else if (world == 2) { // x100 Entiers (3 x 100)
                    n1 = rand(2, 15); 
                    ans = n1 * 100; 
                    op = `${n1} x 100`; 
                    txt = "Ajoute deux 0";
                } 
                else if (world == 3) { // x1000 (Mille)
                    n1 = rand(2, 9); 
                    ans = n1 * 1000; 
                    op = `${n1} x 1000`; 
                    txt = "Mille fois plus";
                } 
                else if (world == 4) { // x10 sur dizaines (30 x 10)
                    n1 = rand(2, 9) * 10; 
                    ans = n1 * 10; 
                    op = `${n1} x 10`; 
                    txt = "Deux z√©ros √† la fin";
                } 
                else if (world == 5) { // Trouve la puissance
                    n1 = rand(2, 9);
                    let p = rand(1, 3); // 1, 2 ou 3 z√©ros
                    let mult = Math.pow(10, p);
                    ans = mult;
                    let res = n1 * mult;
                    op = `${n1} x ? = ${res}`;
                    txt = "10, 100 ou 1000 ?";
                }

                // --- PHASE 2 : LA VIRGULE APPARA√éT (Mondes 6-10) ---
                else if (world == 6) { // D√©cimale simple x10 (2.5 x 10)
                    n1 = rand(11, 99) / 10; // ex: 2.5
                    ans = Math.round(n1 * 10); 
                    op = `${n1} x 10`; 
                    txt = "Virgule √† droite ->";
                } 
                else if (world == 7) { // D√©cimale simple x100 (2.5 x 100)
                    n1 = rand(11, 99) / 10; // ex: 2.5
                    ans = Math.round(n1 * 100); 
                    op = `${n1} x 100`; 
                    txt = "D√©cale de 2 rangs ->";
                } 
                else if (world == 8) { // 0.x fois 10 (0.5 x 10)
                    n1 = rand(1, 9) / 10; // 0.5
                    ans = n1 * 10; 
                    op = `${n1} x 10`; 
                    txt = "√áa devient entier";
                } 
                else if (world == 9) { // 2 chiffres apr√®s virgule (1.25 x 10)
                    n1 = rand(101, 999) / 100; // 1.25
                    ans = parseFloat((n1 * 10).toFixed(1)); 
                    op = `${n1} x 10`; 
                    txt = "D√©cale de 1 rang ->";
                } 
                else if (world == 10) { // 2 chiffres apr√®s virgule (1.25 x 100)
                    n1 = rand(101, 999) / 100; // 1.25
                    ans = Math.round(n1 * 100); 
                    op = `${n1} x 100`; 
                    txt = "Plus de virgule";
                }

                // --- PHASE 3 : LE RECUL (DIVISION) (Mondes 11-15) ---
                else if (world == 11) { // Entier div 10 (25 / 10)
                    n1 = rand(12, 98); 
                    ans = n1 / 10; 
                    op = `${n1} / 10`; 
                    txt = "Virgule √† gauche <-";
                } 
                else if (world == 12) { // Entier div 100 (25 / 100)
                    n1 = rand(12, 98); 
                    ans = n1 / 100; 
                    op = `${n1} / 100`; 
                    txt = "0 virgule...";
                } 
                else if (world == 13) { // D√©cimal div 10 (2.5 / 10)
                    n1 = rand(12, 98) / 10; // 2.5
                    ans = parseFloat((n1 / 10).toFixed(2)); 
                    op = `${n1} / 10`; 
                    txt = "Encore √† gauche <-";
                } 
                else if (world == 14) { // Milli√®mes (div 1000)
                    n1 = rand(1200, 9800); 
                    ans = n1 / 1000; 
                    op = `${n1} / 1000`; 
                    txt = "3 rangs √† gauche";
                } 
                else if (world == 15) { // Retrouver l'op√©ration
                    n1 = rand(20, 90); 
                    let res = n1 / 10;
                    ans = 10; 
                    op = `${n1} / ? = ${res}`; 
                    txt = "Divis√© par ?";
                }

                // --- PHASE 4 : LES PETITS NOMBRES (0.1 et 0.01) (Mondes 16-20) ---
                else if (world == 16) { // Multiplier par 0.1 (= /10)
                    n1 = rand(20, 90); 
                    ans = n1 / 10; 
                    op = `${n1} x 0.1`; 
                    txt = "C'est diviser par 10";
                } 
                else if (world == 17) { // Multiplier par 0.01 (= /100)
                    n1 = rand(200, 900); 
                    ans = n1 / 100; 
                    op = `${n1} x 0.01`; 
                    txt = "C'est diviser par 100";
                } 
                else if (world == 18) { // Division par 0.1 (= x10) - PI√àGE
                    n1 = rand(2, 9); 
                    ans = n1 * 10; 
                    op = `${n1} / 0.1`; 
                    txt = "L'inverse ! (x10)";
                } 
                else if (world == 19) { // Division par 0.01 (= x100)
                    n1 = rand(2, 9); 
                    ans = n1 * 100; 
                    op = `${n1} / 0.01`; 
                    txt = "C'est x100 !";
                } 
                else if (world == 20) { // Complexe 0.x
                    n1 = rand(11, 99)/10; // 2.5
                    ans = parseFloat((n1 / 10).toFixed(2));
                    op = `${n1} x 0.1`; 
                    txt = "Virgule √† gauche";
                }

                // --- PHASE 5 : MA√éTRISE TOTALE (Mondes 21-25) ---
                else if (world == 21) { // 0.005 x 100
                    n1 = rand(1, 9) / 1000; // 0.005
                    ans = parseFloat((n1 * 100).toFixed(1)); 
                    op = `${n1} x 100`; 
                    txt = "Avance de 2";
                } 
                else if (world == 22) { // 0.5 / 10
                    n1 = 0.5; 
                    ans = 0.05; 
                    op = `0.5 / 10`; 
                    txt = "Recule de 1";
                    if(rand(0,1)) { n1=0.2; ans=0.02; op="0.2 / 10"; }
                } 
                else if (world == 23) { // Conversions masqu√©es (km -> m)
                    n1 = rand(1, 9) + 0.5; // 1.5
                    ans = n1 * 1000; 
                    op = `${n1} x 1000`; 
                    txt = "3 z√©ros (d√©calage)";
                } 
                else if (world == 24) { // Alg√®bre de puissance
                    let x = rand(1, 9);
                    let res = x * 100;
                    n1 = 100;
                    ans = x;
                    op = `x . ${n1} = ${res}`;
                    txt = "Trouve x";
                } 
                else { // BOSS FINAL (M√©lange Enfers)
                    if (rand(0, 1)) {
                        // 0.02 / 0.1 -> 0.2
                        n1 = rand(2, 9) / 100; 
                        ans = parseFloat((n1 * 10).toFixed(1)); 
                        op = `${n1} / 0.1`; 
                        txt = "Diviser par 0.1 = x10";
                    } else {
                        // 30 x 0.01 -> 0.3
                        n1 = rand(2, 9) * 10; 
                        ans = parseFloat((n1 / 100).toFixed(1)); 
                        op = `${n1} x 0.01`; 
                        txt = "Multiplier par 0.01 = /100";
                    }
                }
                break;

// === TH√àME 7 : DIVISION SIMPLE (Niveaux 7, 27... 487) ===
            case 6:
                // --- PHASE 1 : BASES ABSOLUES (Mondes 1-5) ---
                if (world == 1) { // Diviser par 2 (Nombres Pairs < 20)
                    ans = rand(2, 10); 
                    n1 = ans * 2; 
                    op = `${n1} / 2`; 
                    txt = "La moiti√©";
                } 
                else if (world == 2) { // Diviser par 10 (Rond)
                    ans = rand(2, 9); 
                    n1 = ans * 10; 
                    op = `${n1} / 10`; 
                    txt = "Enl√®ve le 0";
                } 
                else if (world == 3) { // Diviser par 4 (Table de 4)
                    ans = rand(2, 5); 
                    n1 = ans * 4; 
                    op = `${n1} / 4`; 
                    txt = "Moiti√© de moiti√©";
                } 
                else if (world == 4) { // Diviser par 2 (Dizaines paires)
                    ans = rand(6, 9) * 10; // 60, 70, 80, 90... non 60, 80
                    // Correction : Dizaines paires seulement pour commencer facile
                    let d = rand(2, 4) * 2; // 4, 6, 8
                    n1 = d * 10; 
                    ans = n1 / 2;
                    op = `${n1} / 2`; 
                    txt = "Moiti√© de la dizaine";
                } 
                else if (world == 5) { // Diviser par 10 (Centaines)
                    ans = rand(2, 9) * 10; 
                    n1 = ans * 10; 
                    op = `${n1} / 10`; 
                    txt = "Enl√®ve un 0";
                }

                // --- PHASE 2 : LOGIQUE D√âCIMALE (Mondes 6-10) ---
                else if (world == 6) { // Moiti√© de nombre impair (Petit)
                    // ex : 3 / 2 = 1.5
                    n1 = rand(1, 4) * 2 + 1; // 3, 5, 7, 9
                    ans = n1 / 2; 
                    op = `${n1} / 2`; 
                    txt = "Finit par .5";
                } 
                else if (world == 7) { // Diviser par 10 (D√©cimal simple)
                    // ex : 25 / 10 = 2.5
                    n1 = rand(12, 98); 
                    ans = n1 / 10; 
                    op = `${n1} / 10`; 
                    txt = "Pose la virgule";
                } 
                else if (world == 8) { // Diviser par 4 (Grands nombres ronds)
                    // ex : 80 / 4 = 20
                    let base = rand(5, 9) * 2; // Pair
                    n1 = base * 2 * 10; // Multiple de 40
                    ans = n1 / 4; 
                    op = `${n1} / 4`; 
                    txt = "Moiti√© de moiti√©";
                } 
                else if (world == 9) { // Moiti√© de nombre impair (Grand)
                    // ex : 15 / 2 = 7.5
                    n1 = rand(5, 9) * 2 + 1; // 11 √† 19
                    ans = n1 / 2; 
                    op = `${n1} / 2`; 
                    txt = "√áa finit par .5";
                } 
                else if (world == 10) { // Diviser par 100 (Entier)
                    ans = rand(2, 9); 
                    n1 = ans * 100; 
                    op = `${n1} / 100`; 
                    txt = "Enl√®ve deux 0";
                }

                // --- PHASE 3 : SUBTILIT√âS (Mondes 11-15) ---
                else if (world == 11) { // Diviser par 2 (Dizaine impaire)
                    // ex : 30 / 2 = 15, 50 / 2 = 25
                    let d = rand(1, 4) * 2 + 1; // 3, 5, 7, 9
                    n1 = d * 10; 
                    ans = n1 / 2; 
                    op = `${n1} / 2`; 
                    txt = "Finit par 5";
                } 
                else if (world == 12) { // Diviser par 4 (Nombre complexe)
                    // ex : 12 / 4, 24 / 4...
                    ans = rand(6, 12); 
                    n1 = ans * 4; 
                    op = `${n1} / 4`; 
                    txt = "Dans la table ?";
                } 
                else if (world == 13) { // Diviser par 10 (D√©j√† d√©cimal)
                    // ex : 2.5 / 10 = 0.25
                    ans = rand(12, 45) / 100; 
                    n1 = parseFloat((ans * 10).toFixed(1)); 
                    op = `${n1} / 10`; 
                    txt = "Recule la virgule <-";
                } 
                else if (world == 14) { // Moiti√© de d√©cimal pair
                    // ex : 4.8 / 2 = 2.4
                    let e = rand(2, 8); let d = rand(2, 8);
                    if(e%2!==0) e++; if(d%2!==0) d++;
                    n1 = e + d/10;
                    ans = n1 / 2; 
                    op = `${n1} / 2`; 
                    txt = "Moiti√© de chaque";
                } 
                else if (world == 15) { // Diviser par 20 (Div 10 puis 2)
                    ans = rand(2, 5); 
                    n1 = ans * 20; 
                    op = `${n1} / 20`; 
                    txt = "Coupe 0, puis moiti√©";
                }

                // --- PHASE 4 : EXPERT (Mondes 16-20) ---
                else if (world == 16) { // Diviser par 40 (Div 10 puis 4)
                    ans = rand(2, 5); 
                    n1 = ans * 40; 
                    op = `${n1} / 40`; 
                    txt = "Coupe 0, puis /4";
                } 
                else if (world == 17) { // Quart de 1, 2, 3 (D√©cimal)
                    // 1/4 = 0.25, 2/4 = 0.5, 3/4 = 0.75
                    n1 = rand(1, 3);
                    ans = n1 / 4;
                    op = `${n1} / 4`;
                    txt = "Connais tes quarts";
                } 
                else if (world == 18) { // Division trou (Inverse)
                    n1 = rand(10, 50); 
                    let div = 2; 
                    ans = n1 / 2; 
                    op = `${n1} / ? = ${ans}`; 
                    txt = "Quel diviseur ?";
                } 
                else if (world == 19) { // Diviser par 0.5 (= x2) - PI√àGE
                    ans = rand(4, 12); 
                    n1 = ans / 2; 
                    op = `${n1} / 0.5`; 
                    txt = "Combien de demis ?";
                } 
                else if (world == 20) { // Diviser par 0.1 (= x10) - PI√àGE
                    ans = rand(20, 90); 
                    n1 = ans / 10; 
                    op = `${n1} / 0.1`; 
                    txt = "Combien de dixi√®mes ?";
                }

                // --- PHASE 5 : MA√éTRE (Mondes 21-25) ---
                else if (world == 21) { // Grands nombres / 2
                    // ex : 350 / 2 = 175
                    n1 = rand(3, 9) * 100 + 50; 
                    ans = n1 / 2; 
                    op = `${n1} / 2`; 
                    txt = "D√©compose (300+50)";
                } 
                else if (world == 22) { // Grands nombres / 4
                    // ex : 100 / 4 = 25
                    let base = rand(1, 9); 
                    n1 = base * 100; 
                    ans = n1 / 4; 
                    op = `${n1} / 4`; 
                    txt = "Combien de 25 ?";
                } 
                else if (world == 23) { // Division d√©cimale fine
                    // ex : 3 / 2 = 1.5
                    n1 = rand(3, 9); 
                    if (n1 % 2 === 0) n1++; 
                    ans = n1 / 2; 
                    op = `${n1} / 2`; 
                    txt = "Virgule 5";
                } 
                else if (world == 24) { // Alg√®bre division
                    ans = rand(2, 9); 
                    let div = rand(2, 5); 
                    n1 = ans * div; 
                    op = `${n1} / x = ${ans}`; 
                    txt = "Trouve x";
                } 
                else { // BOSS FINAL (M√©lange)
                    if (rand(0, 1)) {
                        // Diviser par 0.25 (= x4)
                        n1 = rand(2, 8); 
                        ans = n1 * 4; 
                        op = `${n1} / 0.25`; 
                        txt = "Combien de quarts ?";
                    } else {
                        // Division complexe
                        let a = rand(10, 20) * 2; // Pair
                        n1 = a / 10; // ex 2.4
                        ans = n1 / 2; // 1.2
                        op = `${n1} / 2`; 
                        txt = "Moiti√© de d√©cimal";
                    }
                }
                break;

// === TH√àME 8 : ASTUCES MULTIPLICATION (Niveaux 8, 28... 488) ===
            case 7:
                // --- PHASE 1 : LA MAGIE DES CHIFFRES (Mondes 1-5) ---
                if (world == 1) { // x11 (Chiffres)
                    n1 = rand(1, 9); 
                    ans = n1 * 11; 
                    op = `${n1} x 11`; 
                    txt = "Double le chiffre";
                } 
                else if (world == 2) { // x9 (Chiffres)
                    n1 = rand(2, 9); 
                    ans = n1 * 9; 
                    op = `${n1} x 9`; 
                    txt = "x10 moins 1 fois";
                } 
                else if (world == 3) { // x5 (Pairs faciles)
                    let d = rand(1, 4) * 2; // 2, 4, 6, 8
                    n1 = d;
                    ans = n1 * 5; 
                    op = `${n1} x 5`; 
                    txt = "Moiti√© de x10";
                } 
                else if (world == 4) { // x10 vs x9
                    n1 = rand(3, 9);
                    let k = rand(0, 1) ? 10 : 9;
                    ans = n1 * k;
                    op = `${n1} x ${k}`;
                    txt = k===9 ? "Recule de 1 fois" : "Ajoute 0";
                } 
                else if (world == 5) { // x10 vs x11
                    n1 = rand(3, 9);
                    let k = rand(0, 1) ? 10 : 11;
                    ans = n1 * k;
                    op = `${n1} x ${k}`;
                    txt = k===11 ? "Avance de 1 fois" : "Ajoute 0";
                }

                // --- PHASE 2 : DEUX CHIFFRES (Mondes 6-10) ---
                else if (world == 6) { // x11 (10 √† 18) - L'√©cartement
                    // 12 x 11 -> 1 [1+2] 2 -> 132
                    n1 = rand(10, 18); 
                    ans = n1 * 11; 
                    op = `${n1} x 11`; 
                    txt = "√âcarte les chiffres";
                } 
                else if (world == 7) { // x9 (12 √† 19)
                    // 12 x 9 = 120 - 12
                    n1 = rand(12, 19); 
                    ans = n1 * 9; 
                    op = `${n1} x 9`; 
                    txt = "x10 et soustrais";
                } 
                else if (world == 8) { // x5 (Dizaines paires)
                    // 40 x 5 -> 200
                    n1 = rand(2, 8) * 10; 
                    ans = n1 * 5; 
                    op = `${n1} x 5`; 
                    txt = "Moiti√© puis 0";
                } 
                else if (world == 9) { // x5 (Impairs) - Le .5
                    // 7 x 5 = 35
                    n1 = rand(1, 4) * 2 + 1; // 3, 5, 7, 9
                    ans = n1 * 5; 
                    op = `${n1} x 5`; 
                    txt = "Finit par 5";
                } 
                else if (world == 10) { // x50 (Intro)
                    // 4 x 50 = 200
                    n1 = rand(2, 8); 
                    if (n1 % 2 !== 0) n1++; // Pair
                    ans = n1 * 50; 
                    op = `${n1} x 50`; 
                    txt = "x100 divis√© par 2";
                }

                // --- PHASE 3 : CERVEAU MUSCL√â (Mondes 11-15) ---
                else if (world == 11) { // x11 (20 √† 45 sans retenue)
                    // 24 x 11 -> 264
                    let d = rand(2, 4); 
                    let u = rand(1, 4);
                    n1 = d * 10 + u;
                    ans = n1 * 11; 
                    op = `${n1} x 11`; 
                    txt = "Additionne le milieu";
                } 
                else if (world == 12) { // x9 (20 √† 50)
                    n1 = rand(21, 49); 
                    ans = n1 * 9; 
                    op = `${n1} x 9`; 
                    txt = "Retire le nombre";
                } 
                else if (world == 13) { // x5 (Grands pairs)
                    // 48 x 5 -> 240
                    n1 = rand(22, 88); 
                    if (n1 % 2 !== 0) n1++;
                    ans = n1 * 5; 
                    op = `${n1} x 5`; 
                    txt = "Prends la moiti√©";
                } 
                else if (world == 14) { // x15 (x10 + x5)
                    // 6 x 15 = 60 + 30 = 90
                    n1 = rand(2, 8); 
                    if (n1 % 2 !== 0) n1++;
                    ans = n1 * 15; 
                    op = `${n1} x 15`; 
                    txt = "Nombre + sa moiti√©";
                } 
                else if (world == 15) { // x11 (Avec retenue)
                    // 48 x 11 -> 4 (12) 8 -> 528
                    let d = rand(4, 8); 
                    let u = rand(7, 9);
                    n1 = d * 10 + u;
                    ans = n1 * 11; 
                    op = `${n1} x 11`; 
                    txt = "Attention retenue !";
                }

                // --- PHASE 4 : NOUVELLES ASTUCES (Mondes 16-20) ---
                else if (world == 16) { // x99 (x100 - 1)
                    n1 = rand(2, 9); 
                    ans = n1 * 99; 
                    op = `${n1} x 99`; 
                    txt = "x100 moins 1 fois";
                } 
                else if (world == 17) { // x101 (x100 + 1)
                    n1 = rand(2, 9); 
                    ans = n1 * 101; 
                    op = `${n1} x 101`; 
                    txt = "x100 plus 1 fois";
                } 
                else if (world == 18) { // x5 sur D√©cimal (Pair)
                    // 1.2 x 5 = 6
                    let e = rand(1, 8); 
                    if(e%2!==0) e++;
                    n1 = e + 0.2; // 2.2, 4.2...
                    ans = Math.round(n1 * 5); 
                    op = `${n1} x 5`; 
                    txt = "Moiti√© de 10 fois";
                } 
                else if (world == 19) { // x25 (x100 / 4)
                    // 8 x 25 = 200
                    n1 = rand(1, 5) * 4; 
                    ans = n1 * 25; 
                    op = `${n1} x 25`; 
                    txt = "Combien de quarts ?";
                } 
                else if (world == 20) { // x19 (x20 - 1)
                    n1 = rand(2, 6);
                    ans = n1 * 19;
                    op = `${n1} x 19`;
                    txt = "x20 moins le nombre";
                }

                // --- PHASE 5 : MA√éTRISE (Mondes 21-25) ---
                else if (world == 21) { // x5 D√©cimal Complexe
                    // 4.8 x 5 -> 24
                    n1 = rand(2, 9) + 0.8;
                    ans = Math.round(n1 * 5);
                    op = `${n1} x 5`;
                    txt = "Moiti√© de x10";
                } 
                else if (world == 22) { // x11 D√©cimal
                    // 2.4 x 11 -> 26.4
                    let d = rand(1, 3); let u = rand(1, 4);
                    n1 = d + u/10; 
                    ans = parseFloat((n1 * 11).toFixed(1));
                    op = `${n1} x 11`; 
                    txt = "√âcarte autour virgule";
                } 
                else if (world == 23) { // x0.5 (= Diviser par 2)
                    n1 = rand(12, 48);
                    if(n1%2!==0) n1++;
                    ans = n1 / 2;
                    op = `${n1} x 0.5`;
                    txt = "Prends la moiti√©";
                } 
                else if (world == 24) { // x50 Complexe
                    // 12 x 50 = 600
                    n1 = rand(11, 22);
                    if(n1%2!==0) n1++;
                    ans = n1 * 50;
                    op = `${n1} x 50`;
                    txt = "Moiti√© de x100";
                } 
                else { // BOSS FINAL (M√©lange)
                    let k = [9, 11, 5, 25, 50][rand(0, 4)];
                    n1 = rand(12, 24);
                    ans = n1 * k;
                    op = `${n1} x ${k}`;
                    txt = "Applique l'astuce";
                }
                break;

// === TH√àME 9 : LES D√âCIMAUX / ARGENT (Niveaux 9, 29... 489) ===
            case 8:
                // --- PHASE 1 : LA DEMI-PI√àCE (Mondes 1-5) ---
                if (world == 1) { // Entier + 0.5 (2 + 0.5)
                    n1 = rand(1, 9); 
                    n2 = 0.5;
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "Juste la monnaie";
                } 
                else if (world == 2) { // 0.5 + 0.5
                    n1 = 0.5; n2 = 0.5; 
                    ans = 1; 
                    op = `0.5 + 0.5`; 
                    txt = "√áa fait 1 entier";
                } 
                else if (world == 3) { // 1.5 + 1.5 (Doubles de demis)
                    let base = rand(1, 5); 
                    n1 = base + 0.5; 
                    n2 = n1; 
                    ans = n1 + n2; 
                    op = `${n1} + ${n2}`; 
                    txt = "Double de virgule 5";
                } 
                else if (world == 4) { // Soustraction simple (2.5 - 0.5)
                    let base = rand(1, 9); 
                    n1 = base + 0.5; 
                    n2 = 0.5; 
                    ans = base; 
                    op = `${n1} - ${n2}`; 
                    txt = "Enl√®ve la virgule";
                } 
                else if (world == 5) { // Compl√©ment √† l'entier (0.5 + ? = 1)
                    n1 = 0.5; 
                    ans = 0.5; 
                    op = `0.5 + ? = 1`; 
                    txt = "Manque la moiti√©";
                }

                // --- PHASE 2 : RENDRE LA MONNAIE (Mondes 6-10) ---
                else if (world == 6) { // Compl√©ment √† 1 (Facile 0.x)
                    // 1 - 0.8
                    let d = rand(1, 9) / 10; 
                    n1 = 1; n2 = d; 
                    ans = parseFloat((1 - d).toFixed(1)); 
                    op = `1 - ${d}`; 
                    txt = "Compl√©ment √† 10";
                } 
                else if (world == 7) { // Compl√©ment √† 1 (Quarts)
                    // 1 - 0.25
                    n2 = 0.25; 
                    if(rand(0,1)) n2 = 0.75;
                    n1 = 1; 
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    txt = "Pense aux quarts";
                } 
                else if (world == 8) { // Compl√©ment √† 1 (Centimes)
                    // 1 - 0.35 -> Pense 100 - 35
                    let c = rand(15, 85); 
                    n2 = c / 100; 
                    n1 = 1; 
                    ans = parseFloat((1 - n2).toFixed(2)); 
                    op = `${n1} - ${n2}`; 
                    txt = "Rendu sur 1‚Ç¨";
                } 
                else if (world == 9) { // Passer l'entier (0.8 + 0.3)
                    // 0.8 + 0.2 = 1, il reste 0.1
                    let d1 = rand(5, 9); 
                    let d2 = rand(5, 9); 
                    n1 = d1/10; n2 = d2/10; 
                    ans = parseFloat((n1 + n2).toFixed(1)); 
                    op = `${n1} + ${n2}`; 
                    txt = "D√©passe 1";
                } 
                else if (world == 10) { // Soustraction enti√®re (10 - 2.5)
                    n1 = rand(2, 5) * 5; // 10, 15, 20...
                    n2 = rand(1, 5) + 0.5; 
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    txt = "Rendu monnaie";
                }

                // --- PHASE 3 : CALCULS INTELLIGENTS (Mondes 11-15) ---
                else if (world == 11) { // Les nombres amis (1.5 + 2.5)
                    let u1 = rand(1, 5); let u2 = rand(1, 5);
                    n1 = u1 + 0.5; n2 = u2 + 0.5; 
                    ans = u1 + u2 + 1; 
                    op = `${n1} + ${n2}`; 
                    txt = "Les demis font 1";
                } 
                else if (world == 12) { // Compl√©ter l'entier sup (3.2 + ?)
                    let u = rand(1, 5); 
                    let d = rand(1, 9); 
                    n1 = u + d/10; // ex 3.2
                    ans = parseFloat((1 - d/10).toFixed(1)); 
                    op = `${n1} pour aller √† ${u+1}`; 
                    txt = "Bouche le trou";
                } 
                else if (world == 13) { // Addition align√©e (1.2 + 0.05)
                    // Pi√®ge classique : ne pas faire 1.7
                    n1 = 1.2; n2 = 0.05; 
                    ans = 1.25; 
                    op = `${n1} + ${n2}`; 
                    txt = "1.20 + 0.05";
                    if(rand(0,1)) { n1=1.5; n2=0.25; ans=1.75; op="1.5 + 0.25"; }
                } 
                else if (world == 14) { // Soustraction fine (4.5 - 1.2)
                    let u1 = rand(3, 9); let d1 = rand(5, 9);
                    let u2 = rand(1, 2); let d2 = rand(1, 4);
                    n1 = u1 + d1/10; // 4.5
                    n2 = u2 + d2/10; // 1.2
                    ans = parseFloat((n1 - n2).toFixed(1)); 
                    op = `${n1} - ${n2}`; 
                    txt = "Chacun chez soi";
                } 
                else if (world == 15) { // Le pi√®ge du .99 (10 - 0.99)
                    n1 = 10; n2 = 0.99; 
                    ans = 9.01; 
                    op = `10 - 0.99`; 
                    txt = "-1 puis +0.01";
                }

                // --- PHASE 4 : LA VIE R√âELLE (Mondes 16-20) ---
                else if (world == 16) { // Addition 3 nombres (1.5 + 2 + 0.5)
                    let u = rand(1,5);
                    n1 = 1.5; n2 = u; let n3 = 0.5;
                    ans = n1 + n2 + n3; 
                    op = `${n1} + ${n2} + ${n3}`; 
                    txt = "Groupe les virgules";
                } 
                else if (world == 17) { // Gros Rendu (50 - 12.50)
                    n1 = 50; 
                    let u = rand(10, 30);
                    n2 = u + 0.5; 
                    ans = 50 - n2; 
                    op = `${n1} - ${n2}`; 
                    txt = "Compl√©ment 50";
                } 
                else if (world == 18) { // Multiplier par addition (3 x 2.5)
                    // C'est 2.5 + 2.5 + 2.5
                    n1 = 2.5; 
                    let k = rand(2, 4); 
                    ans = n1 * k; 
                    op = `${k} x ${n1}`; 
                    txt = "Additions r√©p√©t√©es";
                } 
                else if (world == 19) { // Quarts d'euros (0.75 + 0.75)
                    n1 = 0.75; n2 = 0.75; 
                    ans = 1.5; 
                    op = `0.75 + 0.75`; 
                    txt = "Trois pi√®ces de 50cts";
                } 
                else if (world == 20) { // Proche de l'entier (4.9 + 0.2)
                    n1 = 4.9; n2 = 0.2; 
                    ans = 5.1; 
                    op = `${n1} + ${n2}`; 
                    txt = "Passe le cap";
                }

                // --- PHASE 5 : COMPTABILIT√â MENTALE (Mondes 21-25) ---
                else if (world == 21) { // √âquation simple (x + 2.5 = 10)
                    let target = 10; 
                    let known = rand(1, 7) + 0.5; 
                    ans = target - known; 
                    n1 = known;
                    op = `x + ${n1} = ${target}`; 
                    txt = "Trouve x";
                } 
                else if (world == 22) { // Soustraction pr√©cise (12.35 - 2.35)
                    let decimal = rand(10, 99)/100; // .35
                    let u1 = rand(10, 20); 
                    let u2 = rand(1, 9);
                    n1 = u1 + decimal; 
                    n2 = u2 + decimal; 
                    ans = parseFloat((n1 - n2).toFixed(2)); 
                    op = `${n1} - ${n2}`; 
                    txt = "Annule la virgule";
                } 
                else if (world == 23) { // Gros doubles (9.5 + 9.5)
                    let u = rand(6, 15); 
                    n1 = u + 0.5; 
                    ans = n1 * 2; 
                    op = `${n1} + ${n1}`; 
                    txt = "Double d√©cimal";
                } 
                else if (world == 24) { // Gros Compl√©ment (100 - 35.5)
                    n1 = 100; 
                    let u = rand(20, 80); 
                    n2 = u + 0.5; 
                    ans = n1 - n2; 
                    op = `${n1} - ${n2}`; 
                    txt = "Compl√©ment 100";
                } 
                else { // BOSS FINAL (M√©lange)
                    // ex: 10.5 - 2.75
                    let u = rand(10, 20); 
                    n1 = u + 0.5; // 10.5
                    n2 = 2.75; 
                    ans = parseFloat((n1 - n2).toFixed(2)); 
                    op = `${n1} - ${n2}`; 
                    txt = "Attention .50 !";
                }
                break;

// === TH√àME 10 : LE TEMPS / BASE 60 (Niveaux 10, 30... 490) ===
            case 9:
                // --- PHASE 1 : LES BASES ET LE PI√àGE ULTIME (Mondes 1-5) ---
                if (world == 1) { // 1h en minutes
                    let h = rand(1, 5); 
                    ans = h * 60; 
                    op = `${h} h en min`; 
                    txt = "1 heure = 60 min";
                } 
                else if (world == 2) { // Le fameux 0.5 h
                    ans = 30; 
                    n1 = 0.5; 
                    op = `0.5 h en min`; 
                    txt = "La moiti√© de 60";
                } 
                else if (world == 3) { // Le quart d'heure (0.25)
                    ans = 15; 
                    n1 = 0.25; 
                    op = `0.25 h en min`; 
                    txt = "Quart de 60";
                } 
                else if (world == 4) { // 1h et demie (1.5)
                    ans = 90; 
                    n1 = 1.5; 
                    op = `1.5 h en min`; 
                    txt = "60 + 30";
                } 
                else if (world == 5) { // Compl√©ment simple (30 min)
                    n1 = 30; 
                    ans = 30; 
                    op = `60 - 30`; 
                    txt = "Demi-heure restante";
                }

                // --- PHASE 2 : COMPL√âMENTS √Ä L'HEURE (Mondes 6-10) ---
                else if (world == 6) { // Compl√©ment Quart (45 min)
                    n1 = 45; 
                    ans = 15; 
                    op = `1 h - 45 min`; 
                    txt = "Il reste un quart";
                } 
                else if (world == 7) { // Compl√©ment 20 min
                    n1 = 20; 
                    ans = 40; 
                    op = `1 h - 20 min`; 
                    txt = "Compl√©ment 60";
                } 
                else if (world == 8) { // Compl√©ment 10 min
                    n1 = 10; 
                    ans = 50; 
                    op = `1 h - 10 min`; 
                    txt = "Compl√©ment 60";
                } 
                else if (world == 9) { // Compl√©ment pr√©cis (5 min)
                    n1 = rand(1, 11) * 5; // 5, 10, 15... 55
                    ans = 60 - n1; 
                    op = `60 - ${n1}`; 
                    txt = "Minutes restantes";
                } 
                else if (world == 10) { // Addition simple (30+40)
                    n1 = 30; 
                    n2 = 40; 
                    ans = 70; 
                    op = `30min + 40min`; 
                    txt = "D√©passer l'heure";
                }

                // --- PHASE 3 : CONVERSION D√âCIMALE (Mondes 11-15) ---
                else if (world == 11) { // 0.1 h (Table de 6)
                    ans = 6; 
                    n1 = 0.1; 
                    op = `0.1 h en min`; 
                    txt = "Un dixi√®me de 60";
                } 
                else if (world == 12) { // 0.2 h (Double de 6)
                    ans = 12; 
                    n1 = 0.2; 
                    op = `0.2 h en min`; 
                    txt = "2 x 6 minutes";
                } 
                else if (world == 13) { // 0.3 h et 0.4 h
                    let k = rand(3, 4); 
                    n1 = k / 10; // 0.3 ou 0.4
                    ans = k * 6; 
                    op = `${n1} h en min`; 
                    txt = "Table de 6";
                } 
                else if (world == 14) { // 0.75 h (Trois quarts)
                    ans = 45; 
                    n1 = 0.75; 
                    op = `0.75 h en min`; 
                    txt = "3 x 15 minutes";
                } 
                else if (world == 15) { // 1/3 d'heure (20 min)
                    ans = 20; 
                    op = `1/3 h en min`; 
                    txt = "60 divis√© par 3";
                }

                // --- PHASE 4 : CALCULS DE DUR√âES (Mondes 16-20) ---
                else if (world == 16) { // Passer l'heure (1h50 + 20min)
                    let m = rand(4, 5) * 10; // 40 ou 50
                    let add = 60 - m + 10; 
                    ans = add + m; 
                    op = `${m}min + ${add}min`; 
                    txt = "D√©passe 60";
                } 
                else if (world == 17) { // Soustraction dur√©e (1h10 - 20min)
                    // Astuce : 1h10 c'est 70 min
                    let start = 70; 
                    let remove = 20; 
                    ans = 50; 
                    op = `1h10 - 20 min`; 
                    txt = "Pense 70 - 20";
                } 
                else if (world == 18) { // Conversion inverse (90 min = ? h)
                    ans = 1.5; 
                    op = `90 min en h`; 
                    txt = "En d√©cimal (1h30)";
                } 
                else if (world == 19) { // Conversion inverse (15 min = ? h)
                    ans = 0.25; 
                    op = `15 min en h`; 
                    txt = "En d√©cimal (Quart)";
                } 
                else if (world == 20) { // De 13h50 √† 14h10
                    let m1 = 50; 
                    let m2 = 10; 
                    ans = 20; 
                    op = `De 13h50 √† 14h10`; 
                    txt = "Combien de min ?";
                }

                // --- PHASE 5 : MA√éTRISE TOTALE (Mondes 21-25) ---
                else if (world == 21) { // 1.2 h (1h + 12min)
                    // Le pi√®ge : 1.2h n'est pas 1h20
                    ans = 72; 
                    n1 = 1.2; 
                    op = `1.2 h en min`; 
                    txt = "1h + 0.2h (2x6)";
                } 
                else if (world == 22) { // 1.25 h (1h + 15min)
                    ans = 75; 
                    n1 = 1.25; 
                    op = `1.25 h en min`; 
                    txt = "1h + un quart";
                } 
                else if (world == 23) { // Fraction d'heure (1/6)
                    ans = 10; 
                    op = `1/6 h en min`; 
                    txt = "60 / 6";
                } 
                else if (world == 24) { // Gros calcul (2h - 45min)
                    ans = 75; 
                    op = `2h - 45 min`; 
                    txt = "R√©sultat en min";
                } 
                else { // BOSS FINAL (Conversion complexe)
                    if (rand(0, 1)) {
                        // 0.6 h -> 36 min
                        ans = 36; 
                        op = `0.6 h en min`; 
                        txt = "6 x 6";
                    } else {
                        // 1.1 h -> 66 min
                        ans = 66; 
                        op = `1.1 h en min`; 
                        txt = "66 minutes";
                    }
                }
                break;

// === TH√àME 11 : CARR√âS PARFAITS (Niveaux 11, 31... 491) ===
            case 10:
                // --- PHASE 1 : LA M√âMOIRE (Mondes 1-5) ---
                if (world == 1) { // Carr√©s de 2 √† 5
                    n1 = rand(2, 5); 
                    ans = n1 * n1; 
                    op = `${n1}¬≤`; 
                    txt = `${n1} x ${n1}`;
                } 
                else if (world == 2) { // Carr√©s de 6 √† 9
                    n1 = rand(6, 9); 
                    ans = n1 * n1; 
                    op = `${n1}¬≤`; 
                    txt = "Table de multiplication";
                } 
                else if (world == 3) { // 10¬≤ et 1¬≤
                    n1 = rand(0, 1) ? 10 : 1; 
                    ans = n1 * n1; 
                    op = `${n1}¬≤`; 
                    txt = "Facile";
                } 
                else if (world == 4) { // Les stars : 11 et 12
                    n1 = rand(11, 12); 
                    ans = n1 * n1; 
                    op = `${n1}¬≤`; 
                    txt = "Par c≈ìur !";
                } 
                else if (world == 5) { // Le pivot 15
                    n1 = 15; 
                    ans = 225; 
                    op = `15¬≤`; 
                    txt = "Finit par 25";
                }

                // --- PHASE 2 : LES "ADOS" DIFFICILES (Mondes 6-10) ---
                else if (world == 6) { // 13 et 14 (169 et 196)
                    n1 = rand(13, 14); 
                    ans = n1 * n1; 
                    op = `${n1}¬≤`; 
                    txt = "Miroirs (69 / 96)";
                } 
                else if (world == 7) { // 20 et 30 (Dizaines)
                    n1 = rand(2, 3) * 10; 
                    ans = n1 * n1; 
                    op = `${n1}¬≤`; 
                    txt = "Carr√© + deux 0";
                } 
                else if (world == 8) { // 16 (Puissance de 2)
                    n1 = 16; 
                    ans = 256; 
                    op = `16¬≤`; 
                    txt = "256 octets";
                } 
                else if (world == 9) { // 25 (Le grand pivot)
                    n1 = 25; 
                    ans = 625; 
                    op = `25¬≤`; 
                    txt = "625";
                } 
                else if (world == 10) { // 17, 18, 19 (Difficiles)
                    n1 = rand(17, 19); 
                    ans = n1 * n1; 
                    op = `${n1}¬≤`; 
                    txt = "Terminaison (7x7=49...)";
                }

                // --- PHASE 3 : RACINES CARR√âES (Mondes 11-15) ---
                else if (world == 11) { // Racine de 1 √† 100
                    let r = rand(2, 9); 
                    n1 = r * r; 
                    ans = r; 
                    op = `Racine de ${n1}`; 
                    txt = "Quel nombre au carr√© ?";
                } 
                else if (world == 12) { // Racine de 121 et 144
                    let r = rand(11, 12); 
                    n1 = r * r; 
                    ans = r; 
                    op = `Racine de ${n1}`; 
                    txt = "Plus grand que 10";
                } 
                else if (world == 13) { // Racine de 400 et 900
                    let r = rand(2, 3) * 10; 
                    n1 = r * r; 
                    ans = r; 
                    op = `Racine de ${n1}`; 
                    txt = "Coupe les z√©ros";
                } 
                else if (world == 14) { // Racine de 169 et 196
                    let r = rand(13, 14); 
                    n1 = r * r; 
                    ans = r; 
                    op = `Racine de ${n1}`; 
                    txt = "Finit par 3 ou 4";
                } 
                else if (world == 15) { // Racine de 225 et 625
                    let r = rand(0, 1) ? 15 : 25; 
                    n1 = r * r; 
                    ans = r; 
                    op = `Racine de ${n1}`; 
                    txt = "Finit par 5";
                }

                // --- PHASE 4 : LOGIQUE & STRUCTURE (Mondes 16-20) ---
                else if (world == 16) { // Dizaines (40¬≤, 50¬≤... 90¬≤)
                    n1 = rand(4, 9) * 10; 
                    ans = n1 * n1; 
                    op = `${n1}¬≤`; 
                    txt = "Carr√© x 100";
                } 
                else if (world == 17) { // Finissant par 5 (35¬≤, 45¬≤)
                    // Astuce : 35¬≤ -> 3x4 = 12 -> 1225
                    let d = rand(3, 8); 
                    n1 = d * 10 + 5; 
                    ans = n1 * n1; 
                    op = `${n1}¬≤`; 
                    txt = "n x (n+1) et 25";
                } 
                else if (world == 18) { // Carr√©s d√©cimaux (1.2¬≤)
                    // 12¬≤ = 144 -> 1.2¬≤ = 1.44
                    let base = rand(11, 15); 
                    n1 = base / 10; 
                    ans = parseFloat((n1 * n1).toFixed(2)); 
                    op = `${n1}¬≤`; 
                    txt = "2 chiffres apr√®s virgule";
                } 
                else if (world == 19) { // Petits d√©cimaux (0.5¬≤, 0.9¬≤)
                    let base = rand(5, 9); 
                    n1 = base / 10; 
                    ans = parseFloat((n1 * n1).toFixed(2)); 
                    op = `${n1}¬≤`; 
                    txt = "0 virgule...";
                } 
                else if (world == 20) { // Racine d√©cimale (‚àö0.25)
                    let base = 5; 
                    if(rand(0,1)) base=rand(11,13); 
                    let sq = (base*base)/100; // 0.25 ou 1.44
                    ans = base/10; 
                    n1 = sq; 
                    op = `Racine de ${n1}`; 
                    txt = "Un chiffre apr√®s virgule";
                }

                // --- PHASE 5 : ALG√àBRE & IDENTIT√âS (Mondes 21-25) ---
                else if (world == 21) { // Identit√© (31¬≤ approx 30¬≤)
                    // Calcul exact : 31¬≤ = 900 + 60 + 1 = 961
                    let d = rand(2, 5); 
                    n1 = d * 10 + 1; 
                    ans = n1 * n1; 
                    op = `${n1}¬≤`; 
                    txt = "d¬≤ + 2d + 1";
                } 
                else if (world == 22) { // 50¬≤ et 500¬≤
                    let p = rand(1, 2); 
                    n1 = 5 * Math.pow(10, p); 
                    ans = n1 * n1; 
                    op = `${n1}¬≤`; 
                    txt = "25 et les z√©ros";
                } 
                else if (world == 23) { // √âquation carr√©e (x¬≤ = 100)
                    ans = rand(5, 15); 
                    n1 = ans * ans; 
                    op = `x¬≤ = ${n1}`; 
                    txt = "Trouve x positif";
                } 
                else if (world == 24) { // Pythagore simple (3¬≤ + 4¬≤)
                    // 9 + 16 = 25
                    let a = 3; let b = 4; ans = 25; 
                    if(rand(0,1)) { a=6; b=8; ans=100; }
                    op = `${a}¬≤ + ${b}¬≤`; 
                    txt = "Somme des carr√©s";
                } 
                else { // BOSS FINAL (M√©lange)
                    if(rand(0,1)) {
                        // 2.5¬≤ = 6.25
                        n1 = 2.5; ans = 6.25; op = "2.5¬≤"; txt = "Entre 2¬≤ et 3¬≤";
                    } else {
                        // 40¬≤ - 1
                        n1 = 40; ans = 1599; op = "40¬≤ - 1"; txt = "1600 - 1";
                    }
                }
                break;

// === TH√àME 12 : FRACTIONS VISUELLES (Niveaux 12, 32... 492) ===
            case 11:
                // --- PHASE 1 : LES CLASSIQUES (Mondes 1-5) ---
                if (world == 1) { // 1/2
                    n1 = 1; ans = 0.5; 
                    op = "1/2"; 
                    txt = "La moiti√©";
                } 
                else if (world == 2) { // 1/4
                    n1 = 1; ans = 0.25; 
                    op = "1/4"; 
                    txt = "Le quart";
                } 
                else if (world == 3) { // 3/4
                    n1 = 3; ans = 0.75; 
                    op = "3/4"; 
                    txt = "Trois quarts (0.75)";
                } 
                else if (world == 4) { // L'entier (2/2, 4/4...)
                    let k = rand(2, 9);
                    ans = 1; 
                    op = `${k}/${k}`; 
                    txt = "Tout le g√¢teau";
                } 
                else if (world == 5) { // Moiti√©s enti√®res (4/2, 6/2)
                    ans = rand(2, 5);
                    n1 = ans * 2; 
                    op = `${n1}/2`; 
                    txt = "Combien de moiti√©s ?";
                }

                // --- PHASE 2 : LES DIXI√àMES ET CENTI√àMES (Mondes 6-10) ---
                else if (world == 6) { // Dixi√®mes simples (3/10)
                    n1 = rand(1, 9); 
                    ans = n1 / 10; 
                    op = `${n1}/10`; 
                    txt = "0 virgule...";
                } 
                else if (world == 7) { // Dixi√®mes > 1 (12/10)
                    n1 = rand(11, 25); 
                    ans = n1 / 10; 
                    op = `${n1}/10`; 
                    txt = "Pose la virgule";
                } 
                else if (world == 8) { // Centi√®mes simples (7/100)
                    n1 = rand(1, 9); 
                    ans = n1 / 100; 
                    op = `${n1}/100`; 
                    txt = "0.0...";
                } 
                else if (world == 9) { // Centi√®mes doubles (25/100)
                    n1 = rand(10, 99); 
                    ans = n1 / 100; 
                    op = `${n1}/100`; 
                    txt = "Deux chiffres apr√®s ,";
                } 
                else if (world == 10) { // Z√©ros inutiles (50/100)
                    n1 = rand(1, 9) * 10; 
                    ans = n1 / 100; 
                    op = `${n1}/100`; 
                    txt = "Simplifie le 0";
                }

                // --- PHASE 3 : LES CINQUI√àMES (ASTUCE x2) (Mondes 11-15) ---
                else if (world == 11) { // 1/5
                    ans = 0.2; 
                    op = "1/5"; 
                    txt = "2/10 donc 0.2";
                } 
                else if (world == 12) { // 2/5
                    ans = 0.4; 
                    op = "2/5"; 
                    txt = "Double de 1/5";
                } 
                else if (world == 13) { // 3/5 et 4/5
                    n1 = rand(3, 4); 
                    ans = n1 * 0.2; 
                    op = `${n1}/5`; 
                    txt = "Multiplie par 2, divise par 10";
                } 
                else if (world == 14) { // 5ths > 1 (6/5, 7/5)
                    n1 = rand(6, 9); 
                    ans = n1 * 0.2; 
                    op = `${n1}/5`; 
                    txt = "Double le haut, d√©cale la virgule";
                } 
                else if (world == 15) { // Grands cinqui√®mes (12/5)
                    n1 = rand(11, 15); 
                    ans = n1 * 2 / 10; 
                    op = `${n1}/5`; 
                    txt = "Astuce du x2";
                }

                // --- PHASE 4 : LES SOUS-MULTIPLES DE 100 (Mondes 16-20) ---
                else if (world == 16) { // Sur 50 (x2)
                    n1 = rand(1, 9); 
                    ans = (n1 * 2) / 100; 
                    op = `${n1}/50`; 
                    txt = "Double pour avoir /100";
                } 
                else if (world == 17) { // Sur 25 (x4) - Faciles
                    n1 = 1; ans = 0.04; op = "1/25"; txt = "x4 sur 100";
                    if(rand(0,1)) { n1=2; ans=0.08; op="2/25"; }
                } 
                else if (world == 18) { // Sur 20 (x5)
                    n1 = rand(1, 4); 
                    ans = (n1 * 5) / 100; 
                    op = `${n1}/20`; 
                    txt = "Fois 5 pour avoir /100";
                } 
                else if (world == 19) { // Sur 25 (Complexes)
                    n1 = rand(3, 6); 
                    ans = n1 * 0.04; 
                    op = `${n1}/25`; 
                    txt = "Haut x 4";
                } 
                else if (world == 20) { // Simplification 20/50
                    let d = [20, 50][rand(0, 1)];
                    n1 = rand(1, 9) * 10; // ex 30
                    ans = n1 / d; 
                    op = `${n1}/${d}`; 
                    txt = "Barre les z√©ros";
                }

                // --- PHASE 5 : EXPERT & HUITI√àMES (Mondes 21-25) ---
                else if (world == 21) { // 1/8 (0.125)
                    ans = 0.125; 
                    op = "1/8"; 
                    txt = "Moiti√© de 0.25";
                } 
                else if (world == 22) { // Tiers (1/3)
                    ans = 0.33; 
                    op = "1/3"; 
                    txt = "0.33 (Environ)";
                } 
                else if (world == 23) { // Simplification (4/8, 6/8)
                    let n = rand(1, 2) * 2; // 2, 4
                    ans = n / 8; 
                    op = `${n}/8`; 
                    txt = "Simplifie la fraction";
                } 
                else if (world == 24) { // Fractions impropres (5/4)
                    ans = 1.25; 
                    op = "5/4"; 
                    txt = "1 + 1/4";
                    if(rand(0,1)) { ans=1.5; op="3/2"; txt="1 + 1/2"; }
                } 
                else { // BOSS FINAL (M√©lange total)
                    // On tire au sort un d√©nominateur parmi les "amis" de 10/100
                    let d = [2, 4, 5, 10, 20, 25, 50][rand(0, 6)];
                    n1 = rand(1, d-1);
                    ans = parseFloat((n1/d).toFixed(2));
                    op = `${n1}/${d}`;
                    txt = "Conversion Rapide";
                }
                break;

// === TH√àME 13 : CONVERSIONS (Niveaux 13, 33... 493) ===
            case 12:
                // --- PHASE 1 : AJOUTER DES Z√âROS (Mondes 1-5) ---
                if (world == 1) { // km en m (x1000)
                    n1 = rand(2, 9); 
                    ans = n1 * 1000; 
                    op = `${n1} km en m`; 
                    txt = "Kilo = 1000";
                } 
                else if (world == 2) { // m en cm (x100)
                    n1 = rand(2, 15); 
                    ans = n1 * 100; 
                    op = `${n1} m en cm`; 
                    txt = "Centi = 100";
                } 
                else if (world == 3) { // kg en g (x1000)
                    n1 = rand(10, 50); 
                    ans = n1 * 1000; 
                    op = `${n1} kg en g`; 
                    txt = "Ajoute 3 z√©ros";
                } 
                else if (world == 4) { // cm en mm (x10)
                    n1 = rand(2, 20); 
                    ans = n1 * 10; 
                    op = `${n1} cm en mm`; 
                    txt = "Juste un 0 (x10)";
                } 
                else if (world == 5) { // L en mL (x1000)
                    n1 = rand(1, 9); 
                    ans = n1 * 1000; 
                    op = `${n1} L en mL`; 
                    txt = "Milli = 1000√®me";
                }

                // --- PHASE 2 : LA VIRGULE BOUGE √Ä DROITE (Mondes 6-10) ---
                else if (world == 6) { // 1.5 km en m
                    n1 = rand(1, 9) + 0.5; // 1.5, 2.5...
                    ans = n1 * 1000; 
                    op = `${n1} km en m`; 
                    txt = "1500 m√®tres";
                } 
                else if (world == 7) { // 1.5 m en cm
                    n1 = rand(1, 5) + 0.5; 
                    ans = n1 * 100; 
                    op = `${n1} m en cm`; 
                    txt = "D√©cale de 2 rangs ->";
                } 
                else if (world == 8) { // 0.5 kg en g
                    n1 = 0.5; 
                    ans = 500; 
                    op = `0.5 kg en g`; 
                    txt = "Moiti√© d'un kilo";
                } 
                else if (world == 9) { // 1.25 m en cm (x100)
                    n1 = rand(1, 9) + 0.25; 
                    ans = n1 * 100; 
                    op = `${n1} m en cm`; 
                    txt = "Virgule dispara√Æt";
                } 
                else if (world == 10) { // 0.1 L en mL
                    n1 = 0.1; 
                    ans = 100; 
                    op = `0.1 L en mL`; 
                    txt = "Un dixi√®me de 1000";
                }

                // --- PHASE 3 : ENLEVER DES Z√âROS (Mondes 11-15) ---
                else if (world == 11) { // m en km (Division 1000)
                    // 5000 m = 5 km
                    ans = rand(1, 9); 
                    n1 = ans * 1000; 
                    op = `${n1} m en km`; 
                    txt = "Enl√®ve 3 z√©ros";
                } 
                else if (world == 12) { // cm en m (Division 100)
                    // 200 cm = 2 m
                    ans = rand(1, 9); 
                    n1 = ans * 100; 
                    op = `${n1} cm en m`; 
                    txt = "Enl√®ve 2 z√©ros";
                } 
                else if (world == 13) { // mm en cm (Division 10)
                    ans = rand(2, 15); 
                    n1 = ans * 10; 
                    op = `${n1} mm en cm`; 
                    txt = "Enl√®ve 1 z√©ro";
                } 
                else if (world == 14) { // g en kg (Virgule appara√Æt)
                    // 500 g = 0.5 kg
                    n1 = 500; 
                    ans = 0.5; 
                    op = `500 g en kg`; 
                    txt = "Moiti√© d'un kilo";
                    if(rand(0,1)) { n1=250; ans=0.25; txt="Quart de kilo"; }
                } 
                else if (world == 15) { // mL en L (Virgule simple)
                    // 1500 mL = 1.5 L
                    ans = rand(1, 5) + 0.5; 
                    n1 = ans * 1000; 
                    op = `${n1} mL en L`; 
                    txt = "1000 mL = 1 L";
                }

                // --- PHASE 4 : UNIT√âS PI√àGES (Mondes 16-20) ---
                else if (world == 16) { // Tonne en kg
                    n1 = rand(1, 5); 
                    ans = n1 * 1000; 
                    op = `${n1} t en kg`; 
                    txt = "1 tonne = 1000 kg";
                } 
                else if (world == 17) { // L en cL (x100, pas 1000 !)
                    n1 = rand(1, 9); 
                    ans = n1 * 100; 
                    op = `${n1} L en cL`; 
                    txt = "Attention : x100";
                } 
                else if (world == 18) { // cL en mL (x10)
                    // Une canette 33cL = 330mL
                    n1 = rand(2, 9) * 10 + rand(1,9); // 23, 33...
                    ans = n1 * 10; 
                    op = `${n1} cL en mL`; 
                    txt = "x10 seulement";
                } 
                else if (world == 19) { // m en km (Petit)
                    // 500m = 0.5km
                    n1 = rand(1, 9) * 100; 
                    ans = n1 / 1000; 
                    op = `${n1} m en km`; 
                    txt = "0 virgule...";
                } 
                else if (world == 20) { // cm en m (Pr√©cis)
                    // 150 cm = 1.5 m
                    n1 = rand(1, 2) * 100 + 50; 
                    ans = n1 / 100; 
                    op = `${n1} cm en m`; 
                    txt = "D√©cale de 2 <-";
                }

                // --- PHASE 5 : SURFACES, VOLUMES & EXPERT (Mondes 21-25) ---
                else if (world == 21) { // Hectare en m¬≤
                    // 1 ha = 10 000 m¬≤
                    n1 = rand(1, 5); 
                    ans = n1 * 10000; 
                    op = `${n1} ha en m¬≤`; 
                    txt = "Ajoute 4 z√©ros !";
                } 
                else if (world == 22) { // m¬≥ en Litres
                    // 1 m¬≥ = 1000 L
                    n1 = rand(1, 5); 
                    ans = n1 * 1000; 
                    op = `${n1} m¬≥ en L`; 
                    txt = "1 m√®tre cube = 1000 L";
                } 
                else if (world == 23) { // Litres en m¬≥ (L'inverse)
                    n1 = rand(1, 5) * 1000; 
                    ans = n1 / 1000; 
                    op = `${n1} L en m¬≥`; 
                    txt = "Enl√®ve 3 z√©ros";
                } 
                else if (world == 24) { // km en m (Complexe)
                    // 0.05 km = 50 m
                    n1 = 0.05; 
                    ans = 50; 
                    op = `0.05 km en m`; 
                    txt = "D√©cale de 3 ->";
                    if(rand(0,1)) { n1=0.002; ans=2; op="0.002 km en m"; }
                } 
                else { // BOSS FINAL (Conversion double)
                    // 1.5 m en mm
                    if (rand(0, 1)) {
                        n1 = 1.5; ans = 1500; op = "1.5 m en mm"; txt = "x1000";
                    } else {
                        // 1500 g en kg
                        n1 = 1500; ans = 1.5; op = "1500 g en kg"; txt = "Divise par 1000";
                    }
                }
                break;

// === TH√àME 14 : OP√âRATIONS SUR FRACTIONS (Niveaux 14, 34... 494) ===
            case 13:
                // --- PHASE 1 : L'ADDITION INTERDITE DU BAS (Mondes 1-5) ---
                if (world == 1) { // 1/4 + 1/4
                    // R√®gle : On additionne le haut, pas le bas
                    let den = [4, 5, 10][rand(0, 2)];
                    n1 = 1; n2 = 1;
                    ans = (n1 + n2) / den; 
                    op = `${n1}/${den} + ${n2}/${den}`; 
                    txt = "R√©sultat en d√©cimal";
                } 
                else if (world == 2) { // 2/5 + 1/5
                    let den = 5;
                    n1 = rand(1, 2); n2 = 1;
                    ans = (n1 + n2) / den; 
                    op = `${n1}/${den} + ${n2}/${den}`; 
                    txt = "Touche pas au 5 !";
                } 
                else if (world == 3) { // Somme = 1 (1/4 + 3/4)
                    let den = [2, 4, 5, 10][rand(0, 3)];
                    n1 = 1; 
                    n2 = den - 1;
                    ans = 1; 
                    op = `${n1}/${den} + ${n2}/${den}`; 
                    txt = "√áa fait un entier";
                } 
                else if (world == 4) { // Soustraction simple (3/4 - 1/4)
                    let den = 4;
                    n1 = 3; n2 = 1;
                    ans = 0.5; 
                    op = `${n1}/${den} - ${n2}/${den}`; 
                    txt = "2/4 c'est la moiti√©";
                } 
                else if (world == 5) { // Somme > 1 (3/4 + 2/4)
                    let den = 4;
                    n1 = 3; n2 = 2;
                    ans = 1.25; 
                    op = `${n1}/${den} + ${n2}/${den}`; 
                    txt = "5 quarts (1.25)";
                }

                // --- PHASE 2 : COMPL√âMENTS ET ENTIERS (Mondes 6-10) ---
                else if (world == 6) { // 1 - 1/4
                    let den = 4;
                    n1 = 1; n2 = 1;
                    ans = 0.75; 
                    op = `1 - 1/${den}`; 
                    txt = "4/4 moins 1/4";
                } 
                else if (world == 7) { // 1 - 3/10
                    let den = 10;
                    n1 = rand(1, 9);
                    ans = (10 - n1) / 10; 
                    op = `1 - ${n1}/${den}`; 
                    txt = "Compl√©ment √† 1";
                } 
                else if (world == 8) { // 1 + 1/2
                    ans = 1.5; 
                    op = `1 + 1/2`; 
                    txt = "Un et demi";
                } 
                else if (world == 9) { // 2 - 1/2
                    ans = 1.5; 
                    op = `2 - 1/2`; 
                    txt = "Deux moins la moiti√©";
                } 
                else if (world == 10) { // 10/10 - 2/10
                    n1 = 10; n2 = rand(1, 9);
                    ans = (n1 - n2) / 10; 
                    op = `${n1}/10 - ${n2}/10`; 
                    txt = "Simplifie le haut";
                }

                // --- PHASE 3 : MULTIPLICATION D'UN ENTIER (Mondes 11-15) ---
                else if (world == 11) { // 2 x 1/4
                    // C'est 1/4 + 1/4
                    ans = 0.5; 
                    op = `2 x 1/4`; 
                    txt = "Deux quarts";
                } 
                else if (world == 12) { // 3 x 1/5
                    ans = 0.6; 
                    op = `3 x 1/5`; 
                    txt = "0.2 + 0.2 + 0.2";
                } 
                else if (world == 13) { // 10 x 1/100
                    ans = 0.1; 
                    op = `10 x 1/100`; 
                    txt = "10 centi√®mes";
                } 
                else if (world == 14) { // 4 x 0.25 (Quarts)
                    ans = 1; 
                    op = `4 x 1/4`; 
                    txt = "4 quarts = 1";
                } 
                else if (world == 15) { // 3 termes (1/5 + 1/5 + 1/5)
                    let den = 5;
                    ans = 0.6; 
                    op = `1/5 + 1/5 + 1/5`; 
                    txt = "Additionne tout";
                }

                // --- PHASE 4 : D√âNOMINATEURS SIMPLES (Mondes 16-20) ---
                else if (world == 16) { // 1/2 + 1/4 (Le pi√®ge)
                    // Il faut visualiser : 1/2 c'est 2/4.
                    ans = 0.75; 
                    op = `1/2 + 1/4`; 
                    txt = "0.5 + 0.25";
                } 
                else if (world == 17) { // 1/2 - 1/4
                    ans = 0.25; 
                    op = `1/2 - 1/4`; 
                    txt = "0.5 - 0.25";
                } 
                else if (world == 18) { // 1.5 + 1/2
                    ans = 2; 
                    op = `1.5 + 1/2`; 
                    txt = "M√©lange D√©cimal/Fraction";
                } 
                else if (world == 19) { // 0.75 - 1/4
                    ans = 0.5; 
                    op = `0.75 - 1/4`; 
                    txt = "Trois quarts moins un";
                } 
                else if (world == 20) { // 1/10 + 0.1
                    ans = 0.2; 
                    op = `1/10 + 0.1`; 
                    txt = "C'est la m√™me chose";
                }

                // --- PHASE 5 : EXPERT & MIXTE (Mondes 21-25) ---
                else if (world == 21) { // 1/2 + 1.5
                    ans = 2; 
                    op = `1/2 + 1.5`; 
                    txt = "Demi + Un et demi";
                } 
                else if (world == 22) { // 5/4 - 1
                    ans = 0.25; 
                    op = `5/4 - 1`; 
                    txt = "1.25 - 1";
                } 
                else if (world == 23) { // 3/2 (Impropre)
                    ans = 1.5; 
                    op = `3/2`; 
                    txt = "1 + 1/2";
                } 
                else if (world == 24) { // 10/4
                    ans = 2.5; 
                    op = `10/4`; 
                    txt = "10 divis√© par 4";
                } 
                else { // BOSS FINAL (Cha√Æne)
                    // 1/2 + 1/4 + 1/4
                    if (rand(0, 1)) {
                        ans = 1; 
                        op = `1/2 + 1/4 + 1/4`; 
                        txt = "Visualise le camembert";
                    } else {
                        // 2 - 3/4
                        ans = 1.25; 
                        op = `2 - 3/4`; 
                        txt = "200 - 75 (cents)";
                    }
                }
                break;

// === TH√àME 15 : DIVISION COMPLEXE (Niveaux 15, 35... 495) ===
            case 14:
                // --- PHASE 1 : L'INVERSE DE 0.1 et 0.5 (Mondes 1-5) ---
                if (world == 1) { // Diviser par 0.1 (Entiers)
                    // 7 / 0.1 = 70
                    n1 = rand(2, 20);
                    ans = n1 * 10; 
                    op = `${n1} / 0.1`; 
                    txt = "C'est x10";
                } 
                else if (world == 2) { // Diviser par 0.5 (Pairs)
                    // 6 / 0.5 = 12
                    n1 = rand(1, 10) * 2;
                    ans = n1 * 2; 
                    op = `${n1} / 0.5`; 
                    txt = "Combien de demis ?";
                } 
                else if (world == 3) { // Diviser par 0.5 (Impairs)
                    // 5 / 0.5 = 10
                    n1 = rand(1, 9) * 2 + 1;
                    ans = n1 * 2; 
                    op = `${n1} / 0.5`; 
                    txt = "C'est x2";
                } 
                else if (world == 4) { // Diviser par 0.1 (D√©cimaux)
                    // 1.5 / 0.1 = 15
                    n1 = rand(1, 9) + 0.5;
                    ans = n1 * 10; 
                    op = `${n1} / 0.1`; 
                    txt = "D√©cale la virgule ->";
                } 
                else if (world == 5) { // Diviser par 0.01
                    // 2 / 0.01 = 200
                    n1 = rand(1, 9);
                    ans = n1 * 100; 
                    op = `${n1} / 0.01`; 
                    txt = "C'est x100";
                }

                // --- PHASE 2 : DIVISER PAR 5 et 50 (Mondes 6-10) ---
                else if (world == 6) { // Diviser par 5 (Ronds)
                    // 20 / 5 = 4
                    ans = rand(2, 12);
                    n1 = ans * 5; 
                    op = `${n1} / 5`; 
                    txt = "Table de 5";
                } 
                else if (world == 7) { // Diviser par 5 (Entiers quelconques)
                    // 12 / 5 = 2.4
                    n1 = rand(6, 18);
                    ans = (n1 * 2) / 10; 
                    op = `${n1} / 5`; 
                    txt = "Double et /10";
                } 
                else if (world == 8) { // Diviser par 50 (Ronds)
                    // 200 / 50 = 4
                    ans = rand(2, 9);
                    n1 = ans * 50; 
                    op = `${n1} / 50`; 
                    txt = "Coupe le 0, div par 5";
                } 
                else if (world == 9) { // Diviser par 50 (Petits)
                    // 12 / 50 = 0.24
                    n1 = rand(11, 40);
                    ans = (n1 * 2) / 100; 
                    op = `${n1} / 50`; 
                    txt = "Double et /100";
                } 
                else if (world == 10) { // Diviser par 500
                    // 1500 / 500 = 3
                    ans = rand(2, 8);
                    n1 = ans * 500; 
                    op = `${n1} / 500`; 
                    txt = "Combien de 500 ?";
                }

                // --- PHASE 3 : DIVISIONS D√âCIMALES INVERSES (Mondes 11-15) ---
                else if (world == 11) { // Diviser par 0.2 (x5)
                    // 4 / 0.2 = 20
                    n1 = rand(2, 8);
                    ans = n1 * 5; 
                    op = `${n1} / 0.2`; 
                    txt = "C'est x5";
                } 
                else if (world == 12) { // Diviser par 0.25 (x4)
                    // 3 / 0.25 = 12
                    n1 = rand(2, 8);
                    ans = n1 * 4; 
                    op = `${n1} / 0.25`; 
                    txt = "Combien de quarts ?";
                } 
                else if (world == 13) { // Diviser par 0.2 (D√©cimal)
                    // 1.2 / 0.2 = 6
                    ans = rand(3, 9);
                    n1 = parseFloat((ans * 0.2).toFixed(1)); 
                    op = `${n1} / 0.2`; 
                    txt = "Comme 12 / 2";
                } 
                else if (world == 14) { // Diviser par 0.5 (Petit d√©cimal)
                    // 0.25 / 0.5 = 0.5
                    n1 = 0.25; ans = 0.5; op = "0.25 / 0.5"; txt = "Double de 0.25";
                    if(rand(0,1)) { n1=0.15; ans=0.3; op="0.15 / 0.5"; }
                } 
                else if (world == 15) { // Diviser par 1.5 (3 demis)
                    // 3 / 1.5 = 2
                    ans = 2; n1 = 3; op = "3 / 1.5"; txt = "Combien de 1.5 ?";
                    if(rand(0,1)) { n1=4.5; ans=3; op="4.5 / 1.5"; }
                }

                // --- PHASE 4 : DIVISIONS ENTRE D√âCIMAUX (Mondes 16-20) ---
                else if (world == 16) { // 2.5 / 5
                    n1 = 2.5; ans = 0.5; 
                    op = `2.5 / 5`; 
                    txt = "Moiti√© de 5 / 5";
                } 
                else if (world == 17) { // 0.6 / 0.2
                    n1 = 0.6; ans = 3; 
                    op = `0.6 / 0.2`; 
                    txt = "Comme 6 / 2";
                } 
                else if (world == 18) { // 0.1 / 0.01
                    ans = 10; 
                    op = `0.1 / 0.01`; 
                    txt = "10 fois plus petit";
                } 
                else if (world == 19) { // 1 / 0.2
                    ans = 5; 
                    op = `1 / 0.2`; 
                    txt = "Combien de 0.2 dans 1 ?";
                } 
                else if (world == 20) { // 3 / 0.03
                    ans = 100; 
                    op = `3 / 0.03`; 
                    txt = "Comme 300 / 3";
                }

                // --- PHASE 5 : MA√éTRE & PI√àGES (Mondes 21-25) ---
                else if (world == 21) { // 1 / 0.001
                    ans = 1000; 
                    op = `1 / 0.001`; 
                    txt = "Milli√®mes";
                } 
                else if (world == 22) { // 7 / 0.5 (Grand)
                    n1 = rand(12, 19);
                    ans = n1 * 2; 
                    op = `${n1} / 0.5`; 
                    txt = "Double le nombre";
                } 
                else if (world == 23) { // 2 / 0.4
                    ans = 5; 
                    op = `2 / 0.4`; 
                    txt = "Comme 20 / 4";
                } 
                else if (world == 24) { // Alg√®bre (x / 0.5 = 10)
                    let target = rand(4, 12);
                    ans = target * 0.5; // La r√©ponse est le x
                    n1 = target; 
                    op = `x / 0.5 = ${n1}`; 
                    txt = "Trouve x (moiti√©)";
                } 
                else { // BOSS FINAL (Division d√©cimale complexe)
                    // 1.5 / 0.25 = 6
                    if (rand(0, 1)) {
                        n1 = 1.5; ans = 6; op = "1.5 / 0.25"; txt = "Combien de quarts ?";
                    } else {
                        // 0.4 / 0.05 = 8
                        n1 = 0.4; ans = 8; op = "0.4 / 0.05"; txt = "Comme 40 / 5";
                    }
                }
                break;

// === TH√àME 16 : POURCENTAGES SIMPLES (Niveaux 16, 36... 496) ===
            case 15:
                // --- PHASE 1 : LES BASES ABSOLUES (Mondes 1-5) ---
                if (world == 1) { // 50% (La moiti√©) - Pairs
                    n1 = rand(1, 10) * 2; 
                    ans = n1 / 2; 
                    op = `50% de ${n1}`; 
                    txt = "C'est la moiti√©";
                } 
                else if (world == 2) { // 100% (Le tout)
                    n1 = rand(5, 50); 
                    ans = n1; 
                    op = `100% de ${n1}`; 
                    txt = "Tout le nombre";
                } 
                else if (world == 3) { // 10% (Multiples de 10)
                    n1 = rand(2, 9) * 10; 
                    ans = n1 / 10; 
                    op = `10% de ${n1}`; 
                    txt = "Enl√®ve le 0";
                } 
                else if (world == 4) { // 50% (Dizaines)
                    n1 = rand(2, 9) * 10; 
                    ans = n1 / 2; 
                    op = `50% de ${n1}`; 
                    txt = "Moiti√© de la dizaine";
                } 
                else if (world == 5) { // 25% (Table de 4)
                    ans = rand(1, 5); 
                    n1 = ans * 4; 
                    op = `25% de ${n1}`; 
                    txt = "C'est le quart (/4)";
                }

                // --- PHASE 2 : D√âCALAGES ET LOGIQUE (Mondes 6-10) ---
                else if (world == 6) { // 10% (Entiers non ronds)
                    // 10% de 25 = 2.5
                    n1 = rand(11, 99); 
                    ans = n1 / 10; 
                    op = `10% de ${n1}`; 
                    txt = "D√©cale la virgule";
                } 
                else if (world == 7) { // 20% (Double de 10%) - Ronds
                    // 20% de 40 = 8
                    let base = rand(2, 9);
                    n1 = base * 10;
                    ans = base * 2; 
                    op = `20% de ${n1}`; 
                    txt = "10% x 2";
                } 
                else if (world == 8) { // 50% (Impairs)
                    // 50% de 7 = 3.5
                    n1 = rand(1, 9) * 2 + 1; 
                    ans = n1 / 2; 
                    op = `50% de ${n1}`; 
                    txt = "Moiti√© √† virgule";
                } 
                else if (world == 9) { // 0% (Le pi√®ge)
                    n1 = rand(10, 100); 
                    ans = 0; 
                    op = `0% de ${n1}`; 
                    txt = "Rien du tout";
                } 
                else if (world == 10) { // 200% (Le double)
                    n1 = rand(2, 12); 
                    ans = n1 * 2; 
                    op = `200% de ${n1}`; 
                    txt = "C'est le double";
                }

                // --- PHASE 3 : LES PETITS POURCENTAGES (Mondes 11-15) ---
                else if (world == 11) { // 1% (Diviser par 100)
                    n1 = rand(2, 9) * 100; 
                    ans = n1 / 100; 
                    op = `1% de ${n1}`; 
                    txt = "Enl√®ve deux 0";
                } 
                else if (world == 12) { // 5% (Moiti√© de 10%) - Ronds
                    // 5% de 40 -> 10%=4 -> 5%=2
                    let base = rand(2, 8) * 2; // Pair
                    n1 = base * 10; 
                    ans = base / 2; 
                    op = `5% de ${n1}`; 
                    txt = "Moiti√© de 10%";
                } 
                else if (world == 13) { // 25% (Centaines)
                    // 25% de 200 = 50
                    n1 = rand(1, 9) * 100; 
                    ans = n1 / 4; 
                    op = `25% de ${n1}`; 
                    txt = "Quart de centaine";
                } 
                else if (world == 14) { // 1% (D√©cimal)
                    // 1% de 150 = 1.5
                    n1 = rand(11, 99) * 10; 
                    ans = n1 / 100; 
                    op = `1% de ${n1}`; 
                    txt = "Divise par 100";
                } 
                else if (world == 15) { // 300% et 400%
                    let p = rand(3, 4);
                    n1 = rand(2, 9); 
                    ans = n1 * p; 
                    op = `${p}00% de ${n1}`; 
                    txt = `Multiplie par ${p}`;
                }

                // --- PHASE 4 : CALCULS COMPOS√âS (Mondes 16-20) ---
                else if (world == 16) { // 75% (3 x 25%)
                    // 75% de 4 = 3
                    let base = rand(1, 4); 
                    n1 = base * 4; 
                    ans = base * 3; 
                    op = `75% de ${n1}`; 
                    txt = "Trois quarts";
                } 
                else if (world == 17) { // 150% (Nombre + Moiti√©)
                    // 150% de 10 = 15
                    let base = rand(2, 8) * 2; 
                    ans = base * 1.5; 
                    n1 = base; 
                    op = `150% de ${n1}`; 
                    txt = "Tout + la moiti√©";
                } 
                else if (world == 18) { // 10% de D√©cimal (0.5)
                    // 10% de 5 = 0.5
                    n1 = rand(1, 9); 
                    ans = n1 / 10; 
                    op = `10% de ${n1}`; 
                    txt = "0 virgule...";
                } 
                else if (world == 19) { // 20% Complexe
                    // 20% de 15 -> 10%=1.5 -> 20%=3
                    n1 = rand(11, 29); 
                    ans = parseFloat(((n1 / 10) * 2).toFixed(1)); 
                    op = `20% de ${n1}`; 
                    txt = "Double la d√©cimale";
                } 
                else if (world == 20) { // 0.5% (Milli√®me x 5) ou Moiti√© de 1%
                    // 0.5% de 200 = 1
                    n1 = rand(1, 5) * 200; 
                    ans = n1 / 200; 
                    op = `0.5% de ${n1}`; 
                    txt = "Moiti√© de 1%";
                }

                // --- PHASE 5 : LOGIQUE INVERS√âE & EXPERT (Mondes 21-25) ---
                else if (world == 21) { // L'inverse : 50% de ? = 10
                    ans = rand(4, 20) * 2; 
                    let res = ans / 2; 
                    n1 = res; 
                    op = `50% de ? = ${n1}`; 
                    txt = "C'est le double";
                } 
                else if (world == 22) { // L'inverse : 10% de ? = 3
                    ans = rand(2, 9) * 10; 
                    let res = ans / 10; 
                    n1 = res; 
                    op = `10% de ? = ${n1}`; 
                    txt = "C'est x10";
                } 
                else if (world == 23) { // 12.5% (1/8)
                    let base = rand(1, 8); 
                    n1 = base * 8; 
                    ans = base; 
                    op = `12.5% de ${n1}`; 
                    txt = "C'est 1/8";
                } 
                else if (world == 24) { // Pourcentage de pourcentage
                    // 50% de 50% de 40 -> 20 -> 10
                    let base = rand(2, 8) * 10; 
                    ans = base / 4; 
                    n1 = base; 
                    op = `50% de 50% de ${n1}`; 
                    txt = "Moiti√© de moiti√©";
                } 
                else { // BOSS FINAL (Astuce de l'inversion)
                    // x% de y = y% de x
                    // 28% de 50 -> dur. Mais 50% de 28 -> 14 !
                    let p = 50;
                    n1 = rand(11, 49); // 28
                    if(rand(0,1)) { p=25; if(n1%4!==0) n1+= (4-(n1%4)); } // Force multiple 4
                    ans = (n1 * p) / 100;
                    op = `${n1}% de ${p}`; 
                    txt = `Calcule ${p}% de ${n1}`;
                }
                break;

// === TH√àME 17 : PRIORIT√âS OP√âRATOIRES (Niveaux 17, 37... 497) ===
            case 16:
                // --- PHASE 1 : LE DUEL (X gagne sur +) (Mondes 1-5) ---
                if (world == 1) { // 2 + 3 x 4
                    let a = rand(1, 5); let b = rand(2, 5); let c = rand(2, 5);
                    ans = a + (b * c); 
                    op = `${a} + ${b} x ${c}`; 
                    txt = "Multiplication d'abord";
                } 
                else if (world == 2) { // 3 x 4 + 2 (Ordre visuel)
                    let a = rand(2, 5); let b = rand(2, 5); let c = rand(2, 5);
                    ans = (a * b) + c; 
                    op = `${a} x ${b} + ${c}`; 
                    txt = "La table en premier";
                } 
                else if (world == 3) { // 20 - 2 x 5 (Soustraction)
                    let b = rand(2, 5); let c = rand(2, 5);
                    let mult = b * c;
                    let a = mult + rand(1, 10); // Pour rester positif
                    ans = a - mult; 
                    op = `${a} - ${b} x ${c}`; 
                    txt = "Attention au moins";
                } 
                else if (world == 4) { // Double multiplication (3x3 + 2x2)
                    let a = rand(2, 4); let b = rand(2, 4);
                    ans = (a*a) + (b*b); 
                    op = `${a}x${a} + ${b}x${b}`; 
                    txt = "Deux multiplications";
                } 
                else if (world == 5) { // Le pi√®ge du 0 (2 + 2 x 0)
                    let a = rand(2, 9);
                    ans = a; 
                    op = `${a} + ${a} x 0`; 
                    txt = "x0 tue le nombre";
                }

                // --- PHASE 2 : LES PARENTH√àSES (LE BOUCLIER) (Mondes 6-10) ---
                else if (world == 6) { // (2 + 3) x 4
                    let a = rand(1, 4); let b = rand(1, 4); let c = rand(2, 5);
                    ans = (a + b) * c; 
                    op = `(${a} + ${b}) x ${c}`; 
                    txt = "Parenth√®se prioritaire";
                } 
                else if (world == 7) { // 2 x (10 - 3)
                    let c = rand(2, 5); let a = 10; let b = rand(1, 5);
                    ans = c * (a - b); 
                    op = `${c} x (${a} - ${b})`; 
                    txt = "Calcule l'int√©rieur";
                } 
                else if (world == 8) { // (2+2) x (3+3)
                    let a = rand(1, 3); let b = rand(1, 3);
                    ans = (a+a) * (b+b); 
                    op = `(${a}+${a}) x (${b}+${b})`; 
                    txt = "Deux paquets";
                } 
                else if (world == 9) { // 20 / (2 + 3)
                    let sum = rand(2, 5); // Diviseur
                    let n1 = rand(2, 5) * sum; // Multiple
                    let a = rand(1, sum-1); let b = sum - a;
                    ans = n1 / sum; 
                    op = `${n1} / (${a} + ${b})`; 
                    txt = "Division √† la fin";
                } 
                else if (world == 10) { // Carr√© de somme (2+1)¬≤
                    let a = rand(1, 3); let b = rand(1, 2);
                    let sum = a + b;
                    ans = sum * sum; 
                    op = `(${a} + ${b})¬≤`; 
                    txt = "Additionne puis Carr√©";
                }

                // --- PHASE 3 : DIVISION ET SOSTRACTION (Mondes 11-15) ---
                else if (world == 11) { // 10 + 8 / 2
                    let a = rand(2, 10); let b = rand(2, 8);
                    if(b%2!==0) b++; // Pair
                    ans = a + (b / 2); 
                    op = `${a} + ${b} / 2`; 
                    txt = "Division gagne";
                } 
                else if (world == 12) { // 20 - 10 / 2
                    let a = 20; let b = rand(2, 10) * 2;
                    ans = a - (b / 2); 
                    op = `${a} - ${b} / 2`; 
                    txt = "Moiti√© en premier";
                } 
                else if (world == 13) { // 4 x 5 / 2 (Gauche Droite)
                    // Multiplier et Diviser ont la m√™me force -> Gauche √† Droite
                    let a = rand(2, 6); let b = 10;
                    ans = (a * b) / 2; 
                    op = `${a} x ${b} / 2`; 
                    txt = "Gauche √† Droite";
                } 
                else if (world == 14) { // 50 / 5 / 2
                    // Pi√®ge : ce n'est pas 50 / 2.5
                    ans = 5; 
                    op = `50 / 5 / 2`; 
                    txt = "10 divis√© par 2";
                } 
                else if (world == 15) { // 10 / 2 + 3 x 2
                    ans = 11; 
                    op = `10 / 2 + 3 x 2`; 
                    txt = "5 + 6";
                }

                // --- PHASE 4 : LOGIQUE ET DISTRIBUTIVIT√â (Mondes 16-20) ---
                else if (world == 16) { // 12 x 3 + 12 x 7 (Facteur commun)
                    // C'est 12 x 10
                    let k = rand(3, 9);
                    let a = rand(1, 4); let b = 10 - a;
                    ans = k * 10; 
                    op = `${k}x${a} + ${k}x${b}`; 
                    txt = "Astuce : x10";
                } 
                else if (world == 17) { // 15 x 6 - 15 x 4
                    // C'est 15 x 2
                    let k = rand(11, 15);
                    let a = 6; let b = 4;
                    ans = k * 2; 
                    op = `${k}x${a} - ${k}x${b}`; 
                    txt = "Astuce : x2";
                } 
                else if (world == 18) { // 4 x 25 + 2
                    ans = 102; 
                    op = `4 x 25 + 2`; 
                    txt = "Cent plus deux";
                } 
                else if (world == 19) { // 0.5 x 10 + 2
                    ans = 7; 
                    op = `0.5 x 10 + 2`; 
                    txt = "5 + 2";
                } 
                else if (world == 20) { // 100 - 9 x 9
                    ans = 19; 
                    op = `100 - 9 x 9`; 
                    txt = "100 - 81";
                }

                // --- PHASE 5 : MA√éTRE (Mondes 21-25) ---
                else if (world == 21) { // D√©cimal (2 + 4 x 0.5)
                    ans = 4; 
                    op = `2 + 4 x 0.5`; 
                    txt = "2 + moiti√© de 4";
                } 
                else if (world == 22) { // 3 + 3 / 0.1
                    // 3 / 0.1 = 30
                    ans = 33; 
                    op = `3 + 3 / 0.1`; 
                    txt = "3 + 30";
                } 
                else if (world == 23) { // 100 / (2 x 5) - Pi√®ge parenth√®se
                    ans = 10; 
                    op = `100 / (2 x 5)`; 
                    txt = "100 divis√© par 10";
                } 
                else if (world == 24) { // Le 5 infernal (5 + 5 x 5 - 5)
                    ans = 25; 
                    op = `5 + 5 x 5 - 5`; 
                    txt = "Le x5 gagne";
                } 
                else { // BOSS FINAL (Tout m√©lang√©)
                    // (10 - 2) x (0.5 + 0.5)
                    if (rand(0, 1)) {
                        ans = 8; 
                        op = `(10 - 2) x (0.5 + 0.5)`; 
                        txt = "8 x 1";
                    } else {
                        // 20 - 4 x 4 + 4
                        ans = 8; 
                        op = `20 - 4 x 4 + 4`; 
                        txt = "20 - 16 + 4";
                    }
                }
                break;

// === TH√àME 18 : R√àGLE DE TROIS / PROPORTIONNALIT√â (Niveaux 18, 38... 498) ===
            case 17:
                // --- PHASE 1 : LA LIN√âARIT√â (Mondes 1-5) ---
                if (world == 1) { // Double direct (1->a, 2->?)
                    let unit = rand(2, 9);
                    n1 = 2; 
                    ans = unit * 2; 
                    op = `1 = ${unit}, 2 = ?`; 
                    txt = "C'est le double";
                } 
                else if (world == 2) { // Triple direct (1->a, 3->?)
                    let unit = rand(2, 9);
                    n1 = 3; 
                    ans = unit * 3; 
                    op = `1 = ${unit}, 3 = ?`; 
                    txt = "C'est le triple";
                } 
                else if (world == 3) { // Multiples de 10 (1->a, 10->?)
                    let unit = rand(2, 9);
                    n1 = 10; 
                    ans = unit * 10; 
                    op = `1 = ${unit}, 10 = ?`; 
                    txt = "Ajoute un 0";
                } 
                else if (world == 4) { // Proportionnalit√© inverse simple (2->20, 1->?)
                    let unit = rand(2, 9) * 10; 
                    n1 = unit / 2; 
                    ans = n1; 
                    op = `2 = ${unit}, 1 = ?`; 
                    txt = "La moiti√©";
                } 
                else if (world == 5) { // Prix simple
                    let price = rand(2, 5); 
                    let qty = rand(2, 5);
                    ans = price * qty; 
                    op = `1 = ${price}‚Ç¨, ${qty} = ?`; 
                    txt = "Prix total";
                }

                // --- PHASE 2 : PASSAGE PAR L'UNIT√â (Mondes 6-10) ---
                else if (world == 6) { // Diviser puis multiplier (2->10, 3->?)
                    let k = rand(2, 5); // Le facteur
                    let start = 2; 
                    let val = start * k; // ex: 2 -> 10 (k=5)
                    let target = 3; 
                    ans = target * k; // 3 -> 15
                    op = `2 = ${val}, 3 = ?`; 
                    txt = "Trouve pour 1 (c'est 5)";
                } 
                else if (world == 7) { // Recette (4 oeufs->200g, 2->?)
                    let base = rand(1, 3) * 100; // 100, 200, 300
                    let start = 4;
                    let target = 2; 
                    ans = base / 2; 
                    op = `4 = ${base}g, 2 = ?`; 
                    txt = "Moiti√© de la recette";
                } 
                else if (world == 8) { // Distance (1h=60km, 2h=?)
                    let speed = rand(4, 9) * 10; // 40, 50... km/h
                    let h = 2;
                    ans = speed * h; 
                    op = `1h = ${speed}km, 2h = ?`; 
                    txt = "Distance double";
                } 
                else if (world == 9) { // Le prix des fruits (3kg = 9‚Ç¨, 5kg = ?)
                    let pricePerKg = rand(2, 6);
                    let start = rand(2, 4);
                    let val = start * pricePerKg; 
                    let target = 5;
                    ans = target * pricePerKg; 
                    op = `${start}kg = ${val}‚Ç¨, ${target}kg = ?`; 
                    txt = `1kg = ${pricePerKg}‚Ç¨`;
                } 
                else if (world == 10) { // Division masqu√©e
                    // 10 stylos = 20‚Ç¨, 1 stylo = ?
                    let p = rand(2, 5);
                    let val = p * 10;
                    ans = p;
                    op = `10 = ${val}‚Ç¨, 1 = ?`;
                    txt = "Divise par 10";
                }

                // --- PHASE 3 : TEMPS ET VITESSE (Mondes 11-15) ---
                else if (world == 11) { // 30 minutes (Moiti√©)
                    let speed = rand(4, 12) * 10; // 60 km/h
                    ans = speed / 2; 
                    op = `1h = ${speed}km, 30min = ?`; 
                    txt = "En 30min, on fait la moiti√©";
                } 
                else if (world == 12) { // 15 minutes (Quart)
                    let speed = rand(2, 8) * 4; // Multiple de 4 (ex 20)
                    ans = speed / 4; 
                    op = `60min = ${speed}, 15min = ?`; 
                    txt = "Le quart";
                } 
                else if (world == 13) { // Proportionnalit√© d√©cimale (1->10, 0.5->?)
                    let base = 10;
                    ans = 5; 
                    op = `1 = 10, 0.5 = ?`; 
                    txt = "Moiti√© de 10";
                } 
                else if (world == 14) { // Echelle (1cm = 5m, 3cm = ?)
                    let scale = rand(2, 10);
                    let dist = rand(2, 5);
                    ans = dist * scale;
                    op = `1cm = ${scale}m, ${dist}cm = ?`;
                    txt = "Multiplie par l'√©chelle";
                } 
                else if (world == 15) { // Produit en croix simple (A/B = C/?)
                    // 2/4 = 5/? -> ? = 10
                    let a = 2; let b = 4;
                    let c = 5; 
                    ans = 10; 
                    op = `${a}/${b} = ${c} / ?`; 
                    txt = "Le double en bas";
                }

                // --- PHASE 4 : CALCULS COMPOS√âS (Mondes 16-20) ---
                else if (world == 16) { // Addition de rapports
                    // Si 2=10 et 3=15, alors 5=? (2+3)
                    let k = rand(2, 6);
                    let v1 = 2 * k; 
                    let v2 = 3 * k;
                    ans = 5 * k; 
                    op = `2=${v1}, 3=${v2}, 5=?`; 
                    txt = "Additionne les r√©sultats";
                } 
                else if (world == 17) { // 1.5 fois (10 -> 15)
                    let base = rand(2, 8) * 2; // Pair
                    let res = base * 1.5;
                    ans = res; 
                    op = `1 = ${base}, 1.5 = ?`; 
                    txt = "Nombre + Moiti√©";
                } 
                else if (world == 18) { // Conversion Monnaie
                    // 1‚Ç¨ = 1.2$, 10‚Ç¨ = ?
                    let rate = 1.2;
                    let amount = rand(2, 9) * 10; 
                    ans = amount * rate; 
                    op = `1‚Ç¨ = ${rate}$, ${amount}‚Ç¨ = ?`; 
                    txt = "x 1.2 (Ajoute 20%)";
                } 
                else if (world == 19) { // R√®gle de 3 sur 100
                    // Si 100 = 50, 10 = ?
                    ans = 5; 
                    op = `100% = 50, 10% = ?`; 
                    txt = "Divise par 10";
                } 
                else if (world == 20) { // Vitesse complexe
                    // 60km/h. 20 min ?
                    let speed = rand(1, 5) * 30; // 30, 60, 90
                    ans = speed / 3; 
                    op = `1h = ${speed}km, 20min = ?`; 
                    txt = "20min c'est un tiers d'heure";
                }

                // --- PHASE 5 : EXPERT (Mondes 21-25) ---
                else if (world == 21) { // 12 -> ? sachant 4 -> ?
                    let k = rand(3, 9);
                    let val4 = 4 * k;
                    ans = 12 * k; 
                    op = `4 = ${val4}, 12 = ?`; 
                    txt = "12 c'est 3 x 4 (Triple)";
                } 
                else if (world == 22) { // 50 -> ? sachant 100 -> ?
                    let val100 = rand(1, 9) * 2 + 1; // Impair
                    ans = val100 / 2; 
                    op = `100 = ${val100}, 50 = ?`; 
                    txt = "Moiti√©";
                } 
                else if (world == 23) { // 2.5 kg -> Prix
                    let p = rand(2, 6) * 2; // Pair
                    ans = p * 2.5; 
                    op = `1kg = ${p}‚Ç¨, 2.5kg = ?`; 
                    txt = "2 fois + moiti√©";
                } 
                else if (world == 24) { // Proportionnalit√© inverse (Vitesse)
                    // √Ä 100km/h je mets 2h. √Ä 200km/h ?
                    let t1 = 2;
                    ans = 1; 
                    op = `100km/h = 2h, 200km/h = ?`; 
                    txt = "Plus vite = Moins de temps";
                } 
                else { // BOSS FINAL (Produit en croix mental)
                    // 4/5 = x/20
                    let a = 4; let b = 5; let d = 20;
                    ans = 16; 
                    op = `${a}/${b} = x/${d}`; 
                    txt = "5 x 4 = 20, donc 4 x 4 = x";
                }
                break;

// === TH√àME 19 : POURCENTAGES COMPOS√âS / FINANCE (Niveaux 19, 39... 499) ===
            case 18:
                // --- PHASE 1 : D√âCOMPOSITION 15% (Mondes 1-5) ---
                if (world == 1) { // 10% (Rappel)
                    n1 = rand(2, 9) * 10; 
                    ans = n1 / 10; 
                    op = `10% de ${n1}`; 
                    txt = "Divise par 10";
                } 
                else if (world == 2) { // 5% (Moiti√© de 10%)
                    let base = rand(2, 8) * 2; // Pair
                    n1 = base * 10; 
                    ans = base / 2; 
                    op = `5% de ${n1}`; 
                    txt = "Moiti√© de 10%";
                } 
                else if (world == 3) { // 15% (10% + 5%) - Ronds
                    // 15% de 200 -> 20 + 10 = 30
                    let base = rand(1, 5) * 100; 
                    let ten = base / 10;
                    ans = ten + (ten / 2); 
                    op = `15% de ${base}`; 
                    txt = "10% + 5%";
                } 
                else if (world == 4) { // 20% (Double de 10%)
                    n1 = rand(2, 9) * 10; 
                    ans = (n1 / 10) * 2; 
                    op = `20% de ${n1}`; 
                    txt = "Double de 10%";
                } 
                else if (world == 5) { // 15% (Dizaines)
                    // 15% de 40 -> 4 + 2 = 6
                    let base = rand(2, 8) * 10; 
                    let ten = base / 10;
                    ans = ten + (ten / 2); 
                    op = `15% de ${base}`; 
                    txt = "10% + la moiti√©";
                }

                // --- PHASE 2 : SOLDES ET REMISES (Mondes 6-10) ---
                else if (world == 6) { // Remise -10%
                    // 50‚Ç¨ - 10% -> 50 - 5 = 45
                    n1 = rand(2, 9) * 10; 
                    ans = n1 - (n1 / 10); 
                    op = `${n1}‚Ç¨ - 10%`; 
                    txt = "Enl√®ve le dixi√®me";
                } 
                else if (world == 7) { // Remise -50%
                    n1 = rand(2, 20) * 2; 
                    ans = n1 / 2; 
                    op = `${n1}‚Ç¨ - 50%`; 
                    txt = "Moiti√© prix";
                } 
                else if (world == 8) { // Remise -20% (Facile)
                    // 100 - 20% = 80
                    n1 = 100; 
                    ans = 80; 
                    op = `100‚Ç¨ - 20%`; 
                    txt = "Enl√®ve 20";
                } 
                else if (world == 9) { // Remise -20% (Complexe)
                    // 50 - 20% -> 10% = 5, 20% = 10 -> 40
                    n1 = rand(1, 5) * 10; 
                    let ten = n1 / 10;
                    ans = n1 - (ten * 2); 
                    op = `${n1}‚Ç¨ - 20%`; 
                    txt = "Enl√®ve 2 fois 10%";
                } 
                else if (world == 10) { // TVA +20%
                    // 50 + 20% -> 60
                    n1 = rand(1, 5) * 10; 
                    let ten = n1 / 10;
                    ans = n1 + (ten * 2); 
                    op = `${n1}‚Ç¨ + 20%`; 
                    txt = "Ajoute 2 fois 10%";
                }

                // --- PHASE 3 : POURCENTAGES COMPOS√âS (Mondes 11-15) ---
                else if (world == 11) { // 30% (3 x 10%)
                    n1 = rand(1, 9) * 10; 
                    ans = (n1 / 10) * 3; 
                    op = `30% de ${n1}`; 
                    txt = "Triple de 10%";
                } 
                else if (world == 12) { // 75% (3/4)
                    let base = rand(1, 4) * 4; 
                    ans = (base / 4) * 3; 
                    op = `75% de ${base}`; 
                    txt = "Trois quarts";
                } 
                else if (world == 13) { // 12.5% (1/8)
                    let base = rand(1, 8) * 8; 
                    ans = base / 8; 
                    op = `12.5% de ${base}`; 
                    txt = "C'est un huiti√®me";
                } 
                else if (world == 14) { // 110% (Augmentation)
                    // 110% de 20 -> 22
                    n1 = rand(1, 9) * 10; 
                    ans = n1 + (n1/10); 
                    op = `110% de ${n1}`; 
                    txt = "Tout + 10%";
                } 
                else if (world == 15) { // 5% de 5% (Cha√Æne)
                    // 50% de 100 -> 50. 50% de 50 -> 25.
                    n1 = rand(1, 4) * 40; 
                    ans = n1 / 4; 
                    op = `50% de 50% de ${n1}`; 
                    txt = "Moiti√© de moiti√©";
                }

                // --- PHASE 4 : CALCULS INVERS√âS & SOLDES (Mondes 16-20) ---
                else if (world == 16) { // Prix final apr√®s -30%
                    // Si -30%, il reste 70%
                    n1 = 100; 
                    ans = 70; 
                    op = `Reste de -30% sur ${n1}`; 
                    txt = "100 - 30";
                } 
                else if (world == 17) { // 90% (Tout moins 10%)
                    n1 = rand(2, 9) * 10; 
                    let ten = n1 / 10;
                    ans = n1 - ten; 
                    op = `90% de ${n1}`; 
                    txt = "Tout sauf 10%";
                } 
                else if (world == 18) { // Retrouver le prix initial (Double)
                    // ? - 50% = 10 -> C'√©tait 20
                    ans = rand(2, 10) * 2; 
                    n1 = ans / 2; 
                    op = `? - 50% = ${n1}`; 
                    txt = "C'√©tait le double";
                } 
                else if (world == 19) { // 1% et 2%
                    n1 = rand(1, 9) * 100; 
                    ans = n1 * 0.02; 
                    op = `2% de ${n1}`; 
                    txt = "Double du centi√®me";
                } 
                else if (world == 20) { // Augmentation 50%
                    // 20 + 50% -> 30
                    n1 = rand(2, 10) * 2; 
                    ans = n1 + (n1/2); 
                    op = `${n1} + 50%`; 
                    txt = "Ajoute la moiti√©";
                }

                // --- PHASE 5 : BANQUIER EXPERT (Mondes 21-25) ---
                else if (world == 21) { // 33% (Tiers)
                    let base = rand(1, 5) * 3; 
                    ans = base / 3; 
                    op = `33% de ${base}`; 
                    txt = "Environ 1/3";
                } 
                else if (world == 22) { // 0.5% (Milli√®me x 5)
                    n1 = 2000; 
                    ans = 10; 
                    op = `0.5% de ${n1}`; 
                    txt = "Moiti√© de 1%";
                } 
                else if (world == 23) { // 2.5% (Quart de 10%)
                    // 2.5% de 400. 10%=40. Quart=10.
                    let base = rand(1, 5) * 400; 
                    ans = base / 40; 
                    op = `2.5% de ${base}`; 
                    txt = "Quart de 10%";
                } 
                else if (world == 24) { // Int√©r√™ts compos√©s (Simple)
                    // 100 + 10% = 110. + 10% = 121.
                    n1 = 100; 
                    ans = 121; 
                    op = `100 + 10% + 10%`; 
                    txt = "110 + 11";
                } 
                else { // BOSS FINAL (Solde complexe)
                    // 60‚Ç¨ - 35%
                    // 10%=6 -> 30%=18. 5%=3. Total rem=21. Prix=39.
                    let base = rand(4, 8) * 20; // 80, 100, 120...
                    let ten = base / 10;
                    let five = ten / 2;
                    let discount = (ten * 3) + five;
                    ans = base - discount;
                    op = `${base}‚Ç¨ - 35%`; 
                    txt = "30% + 5%";
                }
                break;

// === TH√àME 20 : ALG√àBRE / TROUVER X (Niveaux 20, 40... 500) ===
            case 19:
                // --- PHASE 1 : L'INTUITION (Mondes 1-5) ---
                if (world == 1) { // x + a = b (Addition √† trou)
                    n1 = rand(1, 9); // a
                    ans = rand(1, 9); // x
                    let total = n1 + ans; 
                    op = `x + ${n1} = ${total}`; 
                    txt = "Quel nombre + " + n1 + " ?";
                } 
                else if (world == 2) { // x - a = b (Soustraction)
                    let a = rand(1, 9);
                    ans = rand(5, 15); // x
                    let res = ans - a; 
                    op = `x - ${a} = ${res}`; 
                    txt = "x est le plus grand";
                } 
                else if (world == 3) { // ax = b (Multiplication simple)
                    let a = rand(2, 5);
                    ans = rand(2, 9); 
                    let b = a * ans; 
                    op = `${a}x = ${b}`; 
                    txt = "3x veut dire 3 fois x";
                } 
                else if (world == 4) { // a - x = b (Le pi√®ge)
                    // 10 - x = 2 -> x = 8
                    let a = rand(10, 20);
                    ans = rand(1, a-1);
                    let b = a - ans; 
                    op = `${a} - x = ${b}`; 
                    txt = "Inverse les places";
                } 
                else if (world == 5) { // x / a = b (Division)
                    // x / 2 = 5 -> x = 10
                    let a = 2; 
                    let b = rand(2, 10);
                    ans = a * b; 
                    op = `x / ${a} = ${b}`; 
                    txt = "Le double de b";
                }

                // --- PHASE 2 : DEUX √âTAPES (ax + b = c) (Mondes 6-10) ---
                else if (world == 6) { // 2x + 1 = 11
                    ans = rand(1, 9); // x
                    let res = (ans * 2) + 1; 
                    op = `2x + 1 = ${res}`; 
                    txt = "Enl√®ve 1, puis moiti√©";
                } 
                else if (world == 7) { // 3x - 2 = 10
                    ans = rand(2, 9); 
                    let b = rand(1, 5);
                    let res = (ans * 3) - b; 
                    op = `3x - ${b} = ${res}`; 
                    txt = "Ajoute, puis divise";
                } 
                else if (world == 8) { // 5x = 20 (Table de 5)
                    ans = rand(2, 9); 
                    let res = ans * 5; 
                    op = `5x = ${res}`; 
                    txt = "Table de 5";
                } 
                else if (world == 9) { // ax + b = c (Grands nombres)
                    let a = rand(2, 5);
                    let b = rand(10, 20);
                    ans = rand(2, 9);
                    let res = (ans * a) + b;
                    op = `${a}x + ${b} = ${res}`; 
                    txt = "Isole les x";
                } 
                else if (world == 10) { // x/2 + 1 = 5
                    // x/2 = 4 -> x = 8
                    let b = rand(1, 5);
                    let demi = rand(2, 10); // x/2
                    ans = demi * 2; 
                    let res = demi + b;
                    op = `x/2 + ${b} = ${res}`; 
                    txt = "Recule d'un cran";
                }

                // --- PHASE 3 : LOGIQUE DE BALANCE (Mondes 11-15) ---
                else if (world == 11) { // 2x = x + 5
                    ans = rand(2, 15); 
                    op = `2x = x + ${ans}`; 
                    txt = "Enl√®ve un x √† gauche";
                } 
                else if (world == 12) { // 3x = 2x + 10
                    ans = rand(5, 20); 
                    op = `3x = 2x + ${ans}`; 
                    txt = "3 pommes = 2 pommes + ?";
                } 
                else if (world == 13) { // Regroupement (x + x = 10)
                    ans = rand(2, 10); 
                    let res = ans * 2; 
                    op = `x + x = ${res}`; 
                    txt = "2x = ...";
                } 
                else if (world == 14) { // Distributivit√© (2(x+1) = 10)
                    let a = 2;
                    let x = rand(2, 8);
                    ans = x;
                    let res = 2 * (x + 1);
                    op = `2(x + 1) = ${res}`;
                    txt = "Divise le total par 2";
                } 
                else if (world == 15) { // 4x = 12 (Table de 4)
                    ans = rand(3, 9);
                    let res = ans * 4;
                    op = `4x = ${res}`;
                    txt = "Le quart du total";
                }

                // --- PHASE 4 : NOMBRES COMPLEXES (Mondes 16-20) ---
                else if (world == 16) { // Carr√©s (x¬≤ = 25)
                    ans = rand(2, 12); 
                    let sq = ans * ans; 
                    op = `x¬≤ = ${sq}`; 
                    txt = "Racine carr√©e";
                } 
                else if (world == 17) { // 0.5x = 10 (D√©cimal)
                    // La moiti√© de x vaut 10 -> x = 20
                    let res = rand(2, 10);
                    ans = res * 2; 
                    op = `0.5x = ${res}`; 
                    txt = "Multiplie par 2";
                } 
                else if (world == 18) { // 0.1x = 3 (D√©cimal)
                    // Le dixi√®me de x vaut 3 -> x = 30
                    let res = rand(2, 9);
                    ans = res * 10; 
                    op = `0.1x = ${res}`; 
                    txt = "Multiplie par 10";
                } 
                else if (world == 19) { // Variable au d√©nominateur (10/x = 2)
                    ans = rand(2, 9);
                    let num = ans * rand(2, 5);
                    op = `${num}/x = ${num/ans}`; 
                    txt = "√âchange x et le r√©sultat";
                } 
                else if (world == 20) { // √âquation n√©gative simple (x + 5 = 2)
                    // x = -3 (Si tu veux introduire les n√©gatifs)
                    // Sinon on reste positif : 5 - x = 2
                    ans = rand(2, 9);
                    let a = ans + rand(1, 9);
                    op = `${a} - x = ${a-ans}`; 
                    txt = "L'√©cart";
                }

                // --- PHASE 5 : MA√éTRE ALG√àBRE (Mondes 21-25) ---
                else if (world == 21) { // 3x + 5 = 2x + 10
                    // x + 5 = 10 -> x = 5
                    ans = rand(2, 15);
                    let diff = rand(1, 9);
                    let b = rand(2, 10);
                    // 3x + b = 2x + (b+ans)
                    op = `3x + ${b} = 2x + ${b+ans}`;
                    txt = "Annule les x";
                } 
                else if (world == 22) { // x¬≤ + 1 = 26
                    ans = rand(2, 9);
                    let res = (ans * ans) + 1;
                    op = `x¬≤ + 1 = ${res}`; 
                    txt = "Enl√®ve 1, puis Racine";
                } 
                else if (world == 23) { // Pourcentage (20% de x = 10)
                    // x/5 = 10 -> x = 50
                    let res = rand(2, 8);
                    ans = res * 5; 
                    op = `20% de x = ${res}`; 
                    txt = "Le tout (x5)";
                } 
                else if (world == 24) { // Proportion (x/4 = 5)
                    ans = 20; 
                    op = `x / 4 = 5`; 
                    txt = "4 fois 5";
                    if(rand(0,1)) { ans=30; op="x / 5 = 6"; }
                } 
                else { // BOSS FINAL (L'√©quation ultime)
                    // 2(x + 5) = 30
                    // 2x + 10 = 30 -> 2x = 20 -> x = 10
                    ans = rand(5, 20);
                    let factor = 2;
                    let add = rand(2, 9);
                    let res = factor * (ans + add);
                    op = `${factor}(x + ${add}) = ${res}`; 
                    txt = "D√©veloppe ou Divise";
                }
                break;

} // Fin du switch

 	// S√©curit√© r√©ponse
        if (typeof ans === 'number' && !Number.isInteger(ans)) {
            ans = parseFloat(ans.toFixed(2));
        }
        
        // Fallback si bug
        if(ans === undefined) { ans=10; op="5+5"; txt="Niveau Bonus"; }

        return { q: op, a: ans };
    }













// --- CONFIGURATION ---
    const STARS_TO_UNLOCK_NEXT_WORLD = 35; 
    
    // --- CHARGEMENT DES DONN√âES ---
    let savedData = localStorage.getItem('mq_2d');
    window.gameState = savedData ? JSON.parse(savedData) : { unlocked: 1, stars: {} };
    if (!window.gameState.settings) window.gameState.settings = { vib: true, creative: false };

    let currentSession = null;
    let currentScore = 0;
    let targetScore = 20; 
    
    // Variables Timer
    let timerInterval = null;
    let totalTimeAllowed = 100;
    let timeLeft = 100;

    function getTotalStars() {
        return Object.values(window.gameState.stars).reduce((a, b) => a + b, 0);
    }

    // --- GESTION DES PARAM√àTRES ---
    window.settings = {
        open: () => {
            document.getElementById('settings-screen').classList.add('active');
            const vibCheck = document.getElementById('toggle-vib');
            if(vibCheck) vibCheck.checked = window.gameState.settings.vib;
            window.settings.updateBtnStyle();
        },
        save: () => {
            const vibCheck = document.getElementById('toggle-vib');
            if(vibCheck) window.gameState.settings.vib = vibCheck.checked;
            localStorage.setItem('mq_2d', JSON.stringify(window.gameState));
            if(window.gameState.settings.vib && navigator.vibrate) navigator.vibrate(50);
        },
        toggleCreative: () => {
            window.gameState.settings.creative = !window.gameState.settings.creative;
            localStorage.setItem('mq_2d', JSON.stringify(window.gameState));
            window.settings.updateBtnStyle();
            renderGrid();
        },
        updateBtnStyle: () => {
            const btn = document.getElementById('btn-creative');
            if(btn) {
                if(window.gameState.settings.creative) {
                    btn.innerText = "D√âSACTIVER MODE CR√âATIF";
                    btn.classList.add('active');
                } else {
                    btn.innerText = "ACTIVER MODE CR√âATIF";
                    btn.classList.remove('active');
                }
            }
        },
        close: () => {
            document.getElementById('settings-screen').classList.remove('active');
        },
        resetData: () => {
            if(confirm("ATTENTION : Cela va effacer toute ta progression. Tu es s√ªr ?")) {
                localStorage.removeItem('mq_2d');
                location.reload();
            }
        }
    };

    // --- AFFICHAGE DE LA GRILLE ---
    function renderGrid() {
        const container = document.getElementById('grid-container');
        if(!container) return;
        container.innerHTML = "";
        
        let totalStars = getTotalStars();
        let isCreative = window.gameState.settings.creative;
        
        for(let w = 25; w >= 1; w--) {
            let worldSection = document.createElement('div');
            worldSection.className = 'world-container';
            
            let title = document.createElement('div');
            title.className = 'world-title';
            title.innerText = `MONDE ${w}`;
            worldSection.appendChild(title);

            let starsNeeded = (w - 1) * STARS_TO_UNLOCK_NEXT_WORLD;
            let isWorldOpen = (w === 1) || (totalStars >= starsNeeded) || isCreative;

            if (!isWorldOpen) {
                let gate = document.createElement('div');
                gate.className = 'gate-locked';
                gate.innerHTML = `<div class="gate-icon">üîí</div><div class="gate-text">D√©bloquer le Monde ${w}</div><div class="gate-req">${totalStars} / ${starsNeeded} ‚≠ê</div>`;
                worldSection.appendChild(gate);
            } else {
                let line = document.createElement('div');
                line.className = 'world-path-line';
                worldSection.appendChild(line);

                let maxLvl = w * 20;
                let minLvl = (w - 1) * 20 + 1;

                for(let i = maxLvl; i >= minLvl; i--) {
                    let btn = document.createElement('div');
                    btn.className = 'lvl-btn';
                    let stars = window.gameState.stars[i] || 0;
                    
                    let isLocked = (i > window.gameState.unlocked) && !isCreative;
                    
                    if (isLocked) {
                        btn.classList.add('locked');
                        btn.innerHTML = "üîí";
                    } else {
                        btn.innerHTML = `<span style="font-size:1.4rem">${i}</span>`;
                        if(stars > 0) btn.innerHTML += `<div class="stars-icon">${"‚≠ê".repeat(stars)}</div>`;
                        if(stars === 3) btn.classList.add('star3');
                        
                        if(isCreative) btn.classList.add('creative-mode');
                        if(i === window.gameState.unlocked && !isCreative) {
                            btn.classList.add('current');
                            btn.style.color = "black";
                        }
                        
                        btn.onclick = () => window.game.open(i);
                    }
                    worldSection.appendChild(btn);
                }
            }
            container.appendChild(worldSection);
        }
        
        const uiStars = document.getElementById('ui-stars');
        const uiLvl = document.getElementById('ui-lvl');
        if(uiStars) uiStars.innerText = totalStars;
        if(uiLvl) uiLvl.innerText = window.gameState.unlocked;

        setTimeout(() => {
            const currentBtn = document.querySelector('.lvl-btn.current') || document.querySelector('.lvl-btn:not(.locked)');
            if(currentBtn) currentBtn.scrollIntoView({behavior: "smooth", block: "center"});
            else window.scrollTo(0, document.body.scrollHeight);
        }, 100);
    }

    // --- LOGIQUE DU CHRONOM√àTRE ---
    function calculateTimeForLevel(lvl) {
        // Formule : Plus le niveau est haut, plus on a de temps par question
        // Monde 1 (lvl 1-20) : ~5s par question
        // Monde 25 (lvl 481-500) : ~30s par question
        let world = Math.ceil(lvl / 20);
        let timePerQuestion = 4 + world; 
        
        // Ajustement selon le mode cr√©atif ou normal
        let qCount = window.gameState.settings.creative ? 2 : 20;
        
        return qCount * timePerQuestion; 
    }

    function startTimer() {
        if(timerInterval) clearInterval(timerInterval);
        
        const bar = document.getElementById('g-timer-bar');
        bar.className = "timer-bar-fill"; // Reset classes
        bar.style.width = "100%";
        
        timerInterval = setInterval(() => {
            timeLeft--;
            
            // Calcul pourcentage restant
            let pct = (timeLeft / totalTimeAllowed) * 100;
            bar.style.width = pct + "%";
            
            // Couleurs
            if(pct < 30) bar.className = "timer-bar-fill low";
            else if(pct < 60) bar.className = "timer-bar-fill medium";
            
            // Fin du temps = PERDU
            if(timeLeft <= 0) {
                clearInterval(timerInterval);
                window.game.gameOver();
            }
        }, 1000);
    }

    // --- CONTR√îLEUR ---
    window.game = {
        open: (lvl) => {
            // INIT DU NIVEAU
            targetScore = window.gameState.settings.creative ? 2 : 20;
            currentScore = 0; 
            
            // Init Temps
            totalTimeAllowed = calculateTimeForLevel(lvl);
            timeLeft = totalTimeAllowed;
            
            // UI Init
            const targetTxt = document.getElementById('g-target-txt');
            if(targetTxt) targetTxt.innerText = targetScore;
            
            window.game.updateUI(0);
            window.game.nextQuestion(lvl);
            
            const lvlNum = document.getElementById('g-lvl-num');
            if(lvlNum) lvlNum.innerText = lvl;
            
            document.getElementById('game-screen').classList.add('active');
            
            // Lancer le chrono
            startTimer();
        },
        
        nextQuestion: (lvl) => {
            if(typeof generateProblem === "function") {
                let pb = generateProblem(lvl);
                currentSession = { lvl: lvl, ...pb };
                document.getElementById('g-quest').innerText = currentSession.q;
                document.getElementById('g-inp').innerText = "";
            }
        },

        updateUI: (score) => {
            let pct = (score / targetScore) * 100;
            const bar = document.getElementById('g-prog-bar');
            const txt = document.getElementById('g-prog-txt');
            if(bar) bar.style.width = pct + "%";
            if(txt) txt.innerText = score;
        },
        
        gameOver: () => {
            // Temps √©coul√© -> 0 √©toile -> Fermer
            alert("Temps √©coul√© ! ‚è≥\nTu feras mieux la prochaine fois !");
            window.game.close();
        },

        close: () => {
            if(timerInterval) clearInterval(timerInterval);
            document.getElementById('game-screen').classList.remove('active');
            currentSession = null;
        },
        
        tap: (k) => {
            if(window.gameState && window.gameState.settings && window.gameState.settings.vib) {
                if(navigator.vibrate) navigator.vibrate(10);
            }
            let d = document.getElementById('g-inp');
            if(!d) return; 

            if(k === 'DEL') d.innerText = d.innerText.slice(0, -1);
            else if(d.innerText.length < 8) d.innerText += k;
        },
        
        validate: () => {
            if(!currentSession) return;
            let d = document.getElementById('g-inp');
            let screen = document.getElementById('game-screen');
            let userAns = parseFloat(d.innerText.replace(',','.'));
            
            if(userAns === currentSession.a) {
                // BONNE R√âPONSE
                currentScore++;
                window.game.updateUI(currentScore);

                if(currentScore >= targetScore) {
                    // --- NIVEAU GAGN√â ---
                    clearInterval(timerInterval);
                    
                    // Calcul des √©toiles en fonction du temps restant
                    let ratio = timeLeft / totalTimeAllowed;
                    let starsWon = 1; // Minimum 1 si fini
                    
                    if(ratio > 0.6) starsWon = 3;      // Expert (Super rapide)
                    else if(ratio > 0.3) starsWon = 2; // Correct
                    
                    // Sauvegarde
                    if(currentSession.lvl === window.gameState.unlocked) {
                        window.gameState.unlocked++;
                    }
                    
                    // On ne met √† jour les √©toiles que si on fait mieux
                    let oldStars = window.gameState.stars[currentSession.lvl] || 0;
                    if(starsWon > oldStars) {
                        window.gameState.stars[currentSession.lvl] = starsWon;
                    }
                    
                    localStorage.setItem('mq_2d', JSON.stringify(window.gameState));
                    
                    // Petit message de victoire (optionnel mais sympa)
                    let msg = "";
                    if(starsWon === 3) msg = "GENIAL ! ‚≠ê‚≠ê‚≠ê";
                    else if(starsWon === 2) msg = "Bravo ! ‚≠ê‚≠ê";
                    else msg = "Ouf ! ‚≠ê";
                    
                    // Petite pause pour voir le message
                    setTimeout(() => {
                        alert(msg);
                        renderGrid();
                        window.game.close();
                    }, 100);

                } else {
                    window.game.nextQuestion(currentSession.lvl);
                }

            } else {
                // MAUVAISE R√âPONSE
                if(window.gameState.settings.vib && navigator.vibrate) navigator.vibrate(200);
                d.classList.add('shake');
                screen.classList.add('error-flash');

                setTimeout(() => {
                    d.classList.remove('shake');
                    screen.classList.remove('error-flash'); 
                    window.game.nextQuestion(currentSession.lvl); 
                }, 400);
            }
        }
    };

    // --- CLAVIER PHYSIQUE ---
    document.addEventListener('keydown', (e) => {
        if(!currentSession) return;
        if(e.key >= '0' && e.key <= '9') window.game.tap(e.key);
        else if(e.key === '.' || e.key === ',') window.game.tap('.');
        else if(e.key === 'Backspace') window.game.tap('DEL');
        else if(e.key === 'Enter') window.game.validate();
        else if(e.key === 'Escape') window.game.close();
    });

    renderGrid();
</script>
</body>
</html>